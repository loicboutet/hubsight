<% content_for :header, "Contrats" %>

<div class="section">
  <div style="margin-bottom: var(--space-xl);">
    <%= render 'shared/breadcrumb', path: [
      { name: 'Mes Contrats', url: nil }
    ] %>
  </div>
</div>

<div class="section">
  <div style="margin-bottom: var(--space-xl); display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h2 class="typo-h2" style="margin-bottom: var(--space-sm);">Contrats (Lecture seule)</h2>
      <p class="typo-body-small">Consulter les contrats de maintenance, entretien, contrôle et services</p>
    </div>
  </div>

  <%= form_with url: technician_contracts_path, method: :get, local: true, id: "contracts-filter-form", html: { style: "background-color: var(--white); border-radius: var(--space-md);" } do |f| %>
    <!-- Filters Section -->
    <div style="margin-bottom: var(--space-xl); padding: var(--space-lg); background-color: #f8f9fa; border-radius: var(--space-sm);">
      <style>
        @media (max-width: 1200px) {
          .filters-grid-contracts { grid-template-columns: 1fr 1fr 1fr auto auto !important; }
        }
        @media (max-width: 768px) {
          .filters-grid-contracts { grid-template-columns: 1fr !important; }
        }
      </style>
      <div class="filters-grid-contracts" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr auto auto; gap: var(--space-md); align-items: end;">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">Recherche</label>
          <%= f.text_field :search, id: "tech-filter-search", value: params[:search], placeholder: "N° contrat, titre...", style: "width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: var(--space-sm);" %>
        </div>
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">Site</label>
          <%= f.select :site_id, options_from_collection_for_select(Site.by_organization(current_user.organization_id).order(:name), :id, :name, params[:site_id]), { include_blank: "Tous les sites" }, id: "tech-filter-site", style: "width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: var(--space-sm); background-color: white;" %>
        </div>
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">Famille</label>
          <%= f.text_field :family, id: "tech-filter-family", value: params[:family], placeholder: "Maintenance, Nettoyage...", style: "width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: var(--space-sm);" %>
        </div>
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">Prestataire</label>
          <%= f.text_field :contractor, id: "tech-filter-provider", value: params[:contractor], placeholder: "Nom...", style: "width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: var(--space-sm);" %>
        </div>
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">Statut</label>
          <%= f.select :status, [['Tous', ''], ['Actif', 'Actif'], ['En cours', 'En cours'], ['Terminé', 'Terminé']], {}, id: "tech-filter-status", style: "width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: var(--space-sm); background-color: white;" %>
        </div>
        <%= link_to technician_contracts_path, id: "tech-btn-clear-filters", class: "typo-btn-cancel", style: "display: inline-flex; align-items: center; gap: var(--space-sm);" do %>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Effacer
        <% end %>
        <%= f.button type: "submit", id: "tech-btn-apply-filters", class: "typo-btn-success", style: "display: inline-flex; align-items: center; gap: var(--space-sm);" do %>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
          </svg>
          Filtrer
        <% end %>
      </div>
    </div>

    <script>
    // Contract Display Prioritization - Item 2 (Technician)
    // Default filters: Family = "Maintenance", Status = "Active" (Actif)
    // Save/load user filter preferences with localStorage
    
    (function() {
      const STORAGE_KEY = 'technician_contracts_filter_preferences';
      
      // Get filter elements
      const filters = {
        search: document.getElementById('tech-filter-search'),
        site: document.getElementById('tech-filter-site'),
        family: document.getElementById('tech-filter-family'),
        provider: document.getElementById('tech-filter-provider'),
        status: document.getElementById('tech-filter-status')
      };
      
      // Load saved preferences or set defaults
      function loadFilters() {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const preferences = JSON.parse(saved);
            Object.keys(preferences).forEach(key => {
              if (filters[key]) {
                filters[key].value = preferences[key];
              }
            });
          } catch (e) {
            console.error('Error loading filter preferences:', e);
            setDefaults();
          }
        } else {
          setDefaults();
        }
      }
      
      // Set default filter values
      function setDefaults() {
        if (filters.family) filters.family.value = 'Maintenance';
        if (filters.status) filters.status.value = 'Actif';
      }
      
      // Save filter preferences
      function saveFilters() {
        const preferences = {};
        Object.keys(filters).forEach(key => {
          if (filters[key]) {
            preferences[key] = filters[key].value;
          }
        });
        localStorage.setItem(STORAGE_KEY, JSON.stringify(preferences));
      }
      
      // Clear filters
      function clearFilters() {
        Object.values(filters).forEach(filter => {
          if (filter) filter.value = '';
        });
        localStorage.removeItem(STORAGE_KEY);
        setDefaults();
      }
      
      // Initialize on page load
      document.addEventListener('DOMContentLoaded', function() {
        loadFilters();
        
        // Save filters when Apply button is clicked
        const btnApply = document.getElementById('tech-btn-apply-filters');
        if (btnApply) {
          btnApply.addEventListener('click', function() {
            saveFilters();
            // Note: Actual filtering requires backend implementation
          });
        }
        
        // Clear filters when Clear button is clicked
        const btnClear = document.getElementById('tech-btn-clear-filters');
        if (btnClear) {
          btnClear.addEventListener('click', function() {
            clearFilters();
          });
        }
      });
    })();
    </script>

    <!-- Contracts Table -->
    <table style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="border-bottom: 2px solid var(--pink-pale);">
          <th class="typo-body-small typo-bold" style="text-align: left; padding: var(--space-md); color: #666;">N° Contrat</th>
          <th class="typo-body-small typo-bold" style="text-align: left; padding: var(--space-md); color: #666;">Titre / Prestataire</th>
          <th class="typo-body-small typo-bold" style="text-align: left; padding: var(--space-md); color: #666;">Site</th>
          <th class="typo-body-small typo-bold" style="text-align: left; padding: var(--space-md); color: #666;">Famille</th>
          <th class="typo-body-small typo-bold" style="text-align: left; padding: var(--space-md); color: #666;">Montant TTC</th>
          <th class="typo-body-small typo-bold" style="text-align: left; padding: var(--space-md); color: #666;">Dates</th>
          <th class="typo-body-small typo-bold" style="text-align: left; padding: var(--space-md); color: #666;">Statut</th>
          <th class="typo-body-small typo-bold" style="text-align: center; padding: var(--space-md); color: #666;">Actions</th>
        </tr>
      </thead>
      <tbody>
        <% if @contracts.any? %>
          <% @contracts.each do |contract| %>
            <% 
              status_display = case contract.status
                when 'active' then 'Actif'
                when 'pending' then 'En cours'
                when 'expired' then 'Terminé'
                when 'suspended' then 'Suspendu'
                else contract.status&.titleize || '—'
              end
              
              status_style = case contract.status
                when 'active' then 'background-color: #d4edda; color: #155724;'
                when 'pending' then 'background-color: #fff3cd; color: #856404;'
                when 'expired' then 'background-color: #e2e8f0; color: #4a5568;'
                when 'suspended' then 'background-color: #f8d7da; color: #721c24;'
                else 'background-color: #e2e8f0; color: #4a5568;'
              end
            %>
            <tr style="border-bottom: 1px solid #eee;">
              <td class="typo-body-small typo-bold" style="padding: var(--space-md); color: var(--coral-primary);">
                <%= contract.contract_number || '—' %>
              </td>
              <td style="padding: var(--space-md);">
                <p class="typo-body-small typo-bold" style="margin-bottom: 2px;"><%= contract.title || '—' %></p>
                <p class="typo-body-small" style="color: #999; font-size: 0.75rem;"><%= contract.contractor_display_name %></p>
              </td>
              <td class="typo-body-small" style="padding: var(--space-md); color: #666;">
                <%= contract.site&.name || 'Tous sites' %>
              </td>
              <td style="padding: var(--space-md);">
                <% if contract.contract_family.present? %>
                  <span style="display: inline-block; padding: 4px 10px; background-color: #e7f3ff; color: #0066cc; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                    <%= contract.contract_family %>
                  </span>
                <% else %>
                  <span style="color: #999;">—</span>
                <% end %>
              </td>
              <td class="typo-body-small typo-bold" style="padding: var(--space-md);">
                <%= contract.annual_amount_ttc ? number_to_currency(contract.annual_amount_ttc, unit: "€", separator: ",", delimiter: " ", format: "%n %u") : '—' %>
              </td>
              <td class="typo-body-small" style="padding: var(--space-md); color: #666; font-size: 0.8rem;">
                <% if contract.execution_start_date && contract.end_date %>
                  <%= contract.execution_start_date.strftime('%d/%m/%Y') %><br/>
                  → <%= contract.end_date.strftime('%d/%m/%Y') %>
                <% else %>
                  —
                <% end %>
              </td>
              <td style="padding: var(--space-md);">
                <span style="display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; <%= status_style %>">
                  <%= status_display %>
                </span>
              </td>
              <td style="padding: var(--space-md);">
                <div style="display: flex; gap: 6px; justify-content: center;">
                  <%= link_to technician_contract_path(contract), class: "typo-btn-small typo-btn-small-secondary" do %>
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    Voir
                  <% end %>
                  <% if contract.pdf_attached? %>
                    <%= link_to pdf_technician_contract_path(contract), class: "typo-btn-small typo-btn-small-primary" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                      </svg>
                      PDF
                    <% end %>
                  <% end %>
                </div>
              </td>
            </tr>
          <% end %>
        <% else %>
          <tr>
            <td colspan="8" style="padding: var(--space-xl); text-align: center; color: #999;">
              <p class="typo-body">Aucun contrat trouvé</p>
              <% if params[:search].present? || params[:site_id].present? || params[:family].present? || params[:status].present? || params[:contractor].present? %>
                <p class="typo-body-small" style="margin-top: var(--space-sm);">
                  Essayez de modifier vos filtres
                </p>
              <% end %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <!-- Pagination -->
    <% if @contracts.any? %>
      <div style="margin-top: var(--space-xl);">
        <%= render 'shared/pagination', 
          current_page: @contracts.current_page, 
          total_pages: @contracts.total_pages, 
          total_count: @contracts.total_count, 
          per_page: 15,
          path: technician_contracts_path %>
      </div>
    <% end %>
  <% end %>
</div>
