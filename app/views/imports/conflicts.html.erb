<% content_for :header, "Résolution des Conflits d'Importation" %>

<!-- Item 20: Import Conflict Resolution Screen -->
<div class="section">
  <div style="margin-bottom: var(--space-xl);">
    <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: var(--space-lg); border-radius: var(--space-sm); margin-bottom: var(--space-xl);">
      <div style="display: flex; align-items: start; gap: var(--space-md);">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="color: #ffc107; flex-shrink: 0;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
        <div>
          <h3 class="typo-h3" style="color: #856404; margin-bottom: var(--space-sm);">
            Conflits Détectés lors de l'Importation
          </h3>
          <p class="typo-body" style="color: #856404;">
            Des données contradictoires ont été détectées entre le fichier importé et les données existantes. 
            Veuillez résoudre chaque conflit avant de finaliser l'importation.
          </p>
        </div>
      </div>
    </div>

    <!-- Summary Stats -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-lg); margin-bottom: var(--space-xl);">
      <div style="background-color: white; padding: var(--space-lg); border-radius: var(--space-md); border-left: 4px solid #dc3545;">
        <p class="typo-body-small" style="color: #6c757d; margin-bottom: var(--space-xs);">Total Conflits</p>
        <p class="typo-h2" style="color: #dc3545; margin: 0;" id="totalConflicts">12</p>
      </div>
      <div style="background-color: white; padding: var(--space-lg); border-radius: var(--space-md); border-left: 4px solid #28a745;">
        <p class="typo-body-small" style="color: #6c757d; margin-bottom: var(--space-xs);">Résolus</p>
        <p class="typo-h2" style="color: #28a745; margin: 0;" id="resolvedConflicts">0</p>
      </div>
      <div style="background-color: white; padding: var(--space-lg); border-radius: var(--space-md); border-left: 4px solid #ffc107;">
        <p class="typo-body-small" style="color: #6c757d; margin-bottom: var(--space-xs);">En Attente</p>
        <p class="typo-h2" style="color: #ffc107; margin: 0;" id="pendingConflicts">12</p>
      </div>
      <div style="background-color: white; padding: var(--space-lg); border-radius: var(--space-md); border-left: 4px solid #0dcaf0;">
        <p class="typo-body-small" style="color: #6c757d; margin-bottom: var(--space-xs);">Lignes Importées</p>
        <p class="typo-h2" style="color: #0dcaf0; margin: 0;">45</p>
      </div>
    </div>

    <!-- Batch Actions -->
    <div style="background-color: white; padding: var(--space-lg); border-radius: var(--space-md); margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-md);">Actions Groupées</h4>
      <div style="display: flex; gap: var(--space-md); flex-wrap: wrap;">
        <button onclick="resolveAll('keep_existing')" class="typo-btn-primary" style="display: inline-flex; align-items: center; gap: var(--space-sm);">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Tout Garder Existant
        </button>
        <button onclick="resolveAll('use_new')" class="typo-btn-primary" style="display: inline-flex; align-items: center; gap: var(--space-sm);">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
          </svg>
          Tout Remplacer par Import
        </button>
        <button onclick="generateConflictReport()" class="typo-btn-cancel" style="display: inline-flex; align-items: center; gap: var(--space-sm);">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Générer Rapport de Conflits
        </button>
      </div>
    </div>

    <!-- Conflicts Table -->
    <div style="background-color: white; border-radius: var(--space-md); overflow: hidden;">
      <table style="width: 100%; border-collapse: collapse;">
        <thead style="background-color: #34495e; color: white;">
          <tr>
            <th style="padding: var(--space-md); text-align: left; border: 1px solid #2c3e50;">Ligne</th>
            <th style="padding: var(--space-md); text-align: left; border: 1px solid #2c3e50;">Champ</th>
            <th style="padding: var(--space-md); text-align: left; border: 1px solid #2c3e50;">Valeur Existante</th>
            <th style="padding: var(--space-md); text-align: left; border: 1px solid #2c3e50;">Valeur Importée</th>
            <th style="padding: var(--space-md); text-align: center; border: 1px solid #2c3e50; min-width: 250px;">Action</th>
          </tr>
        </thead>
        <tbody id="conflictsTableBody">
          <!-- Sample conflict rows -->
          <tr class="conflict-row" data-row-id="1">
            <td style="padding: var(--space-md); border: 1px solid #dee2e6; font-weight: 600;">1</td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6;">
              <span class="typo-body-small typo-bold" style="color: #495057;">Montant Annuel</span>
              <p class="typo-body-small" style="color: #6c757d; margin-top: 4px;">Contrat: CTR-2024-001</p>
            </td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6;">
              <div style="background-color: #f8f9fa; padding: 8px; border-radius: 4px;">
                <span class="typo-body">50 000 €</span>
                <p class="typo-body-small" style="color: #6c757d; margin-top: 4px;">
                  Modifié par: Jean Dupont<br>
                  Le: 15/11/2025
                </p>
              </div>
            </td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6;">
              <div style="background-color: #e7f3ff; padding: 8px; border-radius: 4px;">
                <span class="typo-body">55 000 €</span>
                <p class="typo-body-small" style="color: #6c757d; margin-top: 4px;">
                  Source: Excel Import<br>
                  Le: 27/11/2025
                </p>
              </div>
            </td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6; text-align: center;">
              <select class="conflict-action-select" data-row-id="1" onchange="handleConflictAction(this)" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.875rem;">
                <option value="">Choisir une action...</option>
                <option value="keep_existing">Garder Existant (50 000 €)</option>
                <option value="use_new">Utiliser Import (55 000 €)</option>
                <option value="manual">Fusion Manuelle</option>
              </select>
              <input type="text" class="manual-value-input" data-row-id="1" placeholder="Valeur manuelle..." style="display: none; width: 100%; margin-top: 8px; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
            </td>
          </tr>

          <tr class="conflict-row" data-row-id="2">
            <td style="padding: var(--space-md); border: 1px solid #dee2e6; font-weight: 600;">2</td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6;">
              <span class="typo-body-small typo-bold" style="color: #495057;">Prestataire</span>
              <p class="typo-body-small" style="color: #6c757d; margin-top: 4px;">Contrat: CTR-2024-002</p>
            </td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6;">
              <div style="background-color: #f8f9fa; padding: 8px; border-radius: 4px;">
                <span class="typo-body">ENGIE Solutions</span>
                <p class="typo-body-small" style="color: #6c757d; margin-top: 4px;">
                  Créé par: Système<br>
                  Le: 01/10/2025
                </p>
              </div>
            </td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6;">
              <div style="background-color: #e7f3ff; padding: 8px; border-radius: 4px;">
                <span class="typo-body">ENGIE SA</span>
                <p class="typo-body-small" style="color: #6c757d; margin-top: 4px;">
                  Source: Excel Import<br>
                  Le: 27/11/2025
                </p>
              </div>
            </td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6; text-align: center;">
              <select class="conflict-action-select" data-row-id="2" onchange="handleConflictAction(this)" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.875rem;">
                <option value="">Choisir une action...</option>
                <option value="keep_existing">Garder Existant (ENGIE Solutions)</option>
                <option value="use_new">Utiliser Import (ENGIE SA)</option>
                <option value="manual">Fusion Manuelle</option>
              </select>
              <input type="text" class="manual-value-input" data-row-id="2" placeholder="Valeur manuelle..." style="display: none; width: 100%; margin-top: 8px; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
            </td>
          </tr>

          <tr class="conflict-row" data-row-id="3">
            <td style="padding: var(--space-md); border: 1px solid #dee2e6; font-weight: 600;">3</td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6;">
              <span class="typo-body-small typo-bold" style="color: #495057;">Date de Fin</span>
              <p class="typo-body-small" style="color: #6c757d; margin-top: 4px;">Contrat: CTR-2024-003</p>
            </td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6;">
              <div style="background-color: #f8f9fa; padding: 8px; border-radius: 4px;">
                <span class="typo-body">31/12/2025</span>
                <p class="typo-body-small" style="color: #6c757d; margin-top: 4px;">
                  Modifié par: Marie Martin<br>
                  Le: 10/11/2025
                </p>
              </div>
            </td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6;">
              <div style="background-color: #e7f3ff; padding: 8px; border-radius: 4px;">
                <span class="typo-body">30/06/2026</span>
                <p class="typo-body-small" style="color: #6c757d; margin-top: 4px;">
                  Source: Excel Import<br>
                  Le: 27/11/2025
                </p>
              </div>
            </td>
            <td style="padding: var(--space-md); border: 1px solid #dee2e6; text-align: center;">
              <select class="conflict-action-select" data-row-id="3" onchange="handleConflictAction(this)" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 0.875rem;">
                <option value="">Choisir une action...</option>
                <option value="keep_existing">Garder Existant (31/12/2025)</option>
                <option value="use_new">Utiliser Import (30/06/2026)</option>
                <option value="manual">Fusion Manuelle</option>
              </select>
              <input type="text" class="manual-value-input" data-row-id="3" placeholder="Valeur manuelle..." style="display: none; width: 100%; margin-top: 8px; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;">
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Action Buttons -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: var(--space-xl); padding: var(--space-lg); background-color: #f8f9fa; border-radius: var(--space-md);">
      <div>
        <p class="typo-body-small" style="color: #6c757d;">
          <span id="resolvedCount">0</span> / <span id="totalCount">12</span> conflits résolus
        </p>
        <div style="width: 300px; height: 8px; background-color: #e9ecef; border-radius: 4px; margin-top: 8px; overflow: hidden;">
          <div id="progressBar" style="width: 0%; height: 100%; background-color: #28a745; transition: width 0.3s;"></div>
        </div>
      </div>
      <div style="display: flex; gap: var(--space-md);">
        <%= link_to imports_path, class: "typo-btn-cancel" do %>
          Annuler l'Importation
        <% end %>
        <button onclick="finalizeImport()" id="finalizeBtn" class="typo-btn-success" disabled style="opacity: 0.5; cursor: not-allowed; display: inline-flex; align-items: center; gap: var(--space-sm);">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
          Finaliser l'Importation
        </button>
      </div>
    </div>
  </div>
</div>

<script>
const conflictResolutions = {};

function handleConflictAction(selectElement) {
  const rowId = selectElement.dataset.rowId;
  const action = selectElement.value;
  const manualInput = document.querySelector(`.manual-value-input[data-row-id="${rowId}"]`);
  
  if (action === 'manual') {
    manualInput.style.display = 'block';
    manualInput.required = true;
  } else {
    manualInput.style.display = 'none';
    manualInput.required = false;
    
    if (action) {
      conflictResolutions[rowId] = { action, value: selectElement.options[selectElement.selectedIndex].text };
      updateProgress();
    }
  }
}

function resolveAll(action) {
  const selects = document.querySelectorAll('.conflict-action-select');
  selects.forEach(select => {
    select.value = action;
    handleConflictAction(select);
  });
}

function updateProgress() {
  const resolved = Object.keys(conflictResolutions).length;
  const total = document.querySelectorAll('.conflict-row').length;
  
  document.getElementById('resolvedConflicts').textContent = resolved;
  document.getElementById('pendingConflicts').textContent = total - resolved;
  document.getElementById('resolvedCount').textContent = resolved;
  document.getElementById('totalCount').textContent = total;
  
  const percentage = (resolved / total) * 100;
  document.getElementById('progressBar').style.width = percentage + '%';
  
  const finalizeBtn = document.getElementById('finalizeBtn');
  if (resolved === total) {
    finalizeBtn.disabled = false;
    finalizeBtn.style.opacity = '1';
    finalizeBtn.style.cursor = 'pointer';
  } else {
    finalizeBtn.disabled = true;
    finalizeBtn.style.opacity = '0.5';
    finalizeBtn.style.cursor = 'not-allowed';
  }
}

function generateConflictReport() {
  // Generate a downloadable report of conflicts
  const report = {
    date: new Date().toISOString(),
    totalConflicts: document.querySelectorAll('.conflict-row').length,
    resolved: Object.keys(conflictResolutions).length,
    resolutions: conflictResolutions
  };
  
  const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `rapport-conflits-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  
  alert('Rapport de conflits généré et téléchargé !');
}

function finalizeImport() {
  if (Object.keys(conflictResolutions).length !== document.querySelectorAll('.conflict-row').length) {
    alert('Veuillez résoudre tous les conflits avant de finaliser l\'importation.');
    return;
  }
  
  // In a real implementation, this would send the resolutions to the backend
  console.log('Import finalized with resolutions:', conflictResolutions);
  alert('Importation finalisée avec succès !');
  // Redirect to import success page or contracts list
  // window.location.href = '/contracts';
}
</script>
