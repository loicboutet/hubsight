<% content_for :header, "Sites" %>

<div class="section">
  <div class="page-header-responsive">
    <div>
      <h2 class="typo-h2" style="margin-bottom: var(--space-sm);">Mes Sites</h2>
      <p class="typo-body-small">Gérer la structure patrimoniale - Sites, Bâtiments, Niveaux, Espaces</p>
    </div>
    <div style="display: flex; gap: var(--space-sm); align-items: center;">
      <!-- Export Buttons -->
      <div style="display: flex; gap: var(--space-xs);">
        <%= link_to exports_sites_path(export_format: 'hierarchical'), 
            class: "page-header-btn",
            style: "background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;",
            title: "Export structure hiérarchique (1 feuille)",
            data: { turbo: false } do %>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
          </svg>
          Export Hiérarchique
        <% end %>
        
        <%= link_to exports_sites_path(export_format: 'sheets'), 
            class: "page-header-btn",
            style: "background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;",
            title: "Export multi-feuilles (5 feuilles séparées)",
            data: { turbo: false } do %>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Export Multi-Feuilles
        <% end %>
      </div>
      
      <a href="<%= new_site_path %>" class="typo-btn-success page-header-btn">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Nouveau Site
      </a>
    </div>
  </div>

  <div style="background-color: var(--white); border-radius: var(--space-md); " data-controller="site-list">
    <!-- Filters Section -->
    <div style="margin-bottom: var(--space-xl); padding: var(--space-lg); background-color: #f8f9fa; border-radius: var(--space-sm);">
      <style>
        @media (max-width: 1200px) {
          .filters-grid-sites { grid-template-columns: 1fr 1fr auto auto !important; }
        }
        @media (max-width: 768px) {
          .filters-grid-sites { grid-template-columns: 1fr !important; }
        }
      </style>
      <%= form_with url: sites_path, method: :get, data: { site_list_target: "filterForm", action: "submit->site-list#applyFilters" } do |f| %>
        <div class="filters-grid-sites" style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto auto; gap: var(--space-md); align-items: end;">
          <div>
            <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">Recherche</label>
            <%= f.text_field :search, 
                value: params[:search],
                placeholder: "Nom du site, ville...", 
                data: { site_list_target: "searchInput" },
                style: "width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: var(--space-sm);" %>
          </div>
          <div>
            <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);"> Type d'usage du site</label>
            <%= f.select :site_type, 
                options_for_select([
                  ['Tous', ''],
                  ['Bureaux', 'bureaux'],
                  ['Industriel', 'industriel'],
                  ['Commercial', 'commercial'],
                  ['Résidentiel', 'residentiel'],
                  ['Logistique', 'logistique'],
                  ['Santé', 'sante'],
                  ['Enseignement', 'enseignement'],
                  ['Autre', 'autre']
                ], params[:site_type]),
                {},
                data: { site_list_target: "typeSelect" },
                style: "width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: var(--space-sm); background-color: white;" %>
          </div>
          <div>
            <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">Région</label>
            <%= f.select :region,
                options_for_select([
                  ['Toutes', ''],
                  ['Île-de-France', 'ile-de-france'],
                  ['PACA', 'provence-alpes-cote-azur'],
                  ['Auvergne-Rhône-Alpes', 'auvergne-rhone-alpes'],
                  ['Hauts-de-France', 'hauts-de-france'],
                  ['Grand Est', 'grand-est'],
                  ['Nouvelle-Aquitaine', 'nouvelle-aquitaine'],
                  ['Occitanie', 'occitanie']
                ], params[:region]),
                {},
                data: { site_list_target: "regionSelect" },
                style: "width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: var(--space-sm); background-color: white;" %>
          </div>
          <div>
            <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">Trier par</label>
            <%= f.select :sort_by,
                options_for_select([
                  ['Nom (A-Z)', ''],
                  ['Surface', 'area'],
                  ['Nb. Bâtiments', 'buildings_count']
                ], params[:sort_by]),
                {},
                data: { site_list_target: "sortSelect", action: "change->site-list#changeSort" },
                style: "width: 100%; padding: 10px; border: 1px solid var(--light-gray); border-radius: var(--space-sm); background-color: white;" %>
          </div>
          <button type="button" 
                  data-action="click->site-list#clearFilters"
                  class="typo-btn-cancel" 
                  style="display: inline-flex; align-items: center; gap: var(--space-sm);">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
            Effacer
          </button>
          <button type="submit" class="typo-btn-success" style="display: inline-flex; align-items: center; gap: var(--space-sm);">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
            </svg>
            Filtrer
          </button>
        </div>
      <% end %>
    </div>

    <!-- Sites Table -->
    <div class="table-responsive">
      <% if @sites.any? %>
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background-color: #f8f9fa; border-bottom: 2px solid var(--pink-pale);">
              <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">SITE</th>
              <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">LOCALISATION</th>
              <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">TYPE</th>
              <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">SURFACE</th>
              <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">BÂTIMENTS</th>
              <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">ÉQUIPEMENTS</th>
              <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">CONTRATS</th>
              <th style="padding: var(--space-md); text-align: right; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">ACTIONS</th>
            </tr>
          </thead>
          <tbody>
            <% @sites.each_with_index do |site, index| %>
              <tr style="border-bottom: 1px solid #e9ecef; <%= 'background-color: #fafbfc;' if index.even? %>">
                <!-- Site Name -->
                <td style="padding: var(--space-md);">
                  <div>
                    <%= link_to site_path(site), style: "text-decoration: none;" do %>
                      <p class="typo-body-small typo-bold" style="margin-bottom: 2px; color: var(--coral-primary); transition: color 0.2s;"><%= site.name %></p>
                    <% end %>
                    <p class="typo-body-small" style="color: #999; font-size: 0.813rem;"><%= site.address %></p>
                  </div>
                </td>
                
                <!-- Location -->
                <td style="padding: var(--space-md);">
                  <div>
                    <p class="typo-body-small"><%= site.city %></p>
                    <p class="typo-body-small" style="color: #999; font-size: 0.813rem;"><%= site.region_label %></p>
                  </div>
                </td>
                
                <!-- Type -->
                <td style="padding: var(--space-md);">
                  <span style="display: inline-block; padding: 4px 12px; background-color: #e7f3ff; color: #0066cc; border-radius: 12px; font-size: 0.813rem; font-weight: 600;">
                    <%= site.site_type_label %>
                  </span>
                </td>
                
                <!-- Surface -->
                <td style="padding: var(--space-md); text-align: center;">
                  <p class="typo-body-small typo-bold" style="color: var(--coral-primary);"><%= site.formatted_area || 'N/A' %></p>
                </td>
                
                <!-- Buildings -->
                <td style="padding: var(--space-md); text-align: center;">
                  <p class="typo-body-small typo-bold"><%= site.buildings_count %></p>
                </td>
                
                <!-- Equipment -->
                <td style="padding: var(--space-md); text-align: center;">
                  <p class="typo-body-small">0</p>
                </td>
                
                <!-- Contracts -->
                <td style="padding: var(--space-md); text-align: center;">
                  <p class="typo-body-small">0</p>
                </td>
                
                <!-- Actions -->
                <td style="padding: var(--space-md);">
                  <div style="display: flex; gap: var(--space-xs); justify-content: flex-end;">
                    <%= link_to site_path(site), title: "Voir", class: "typo-btn-small typo-btn-small-secondary" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      Voir
                    <% end %>
                    <%= link_to edit_site_path(site), title: "Éditer", class: "typo-btn-small typo-btn-small-primary" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                      </svg>
                      Éditer
                    <% end %>
                    <button type="button" 
                      data-action="open-delete-modal" 
                      data-modal-id="deletion-modal-site-<%= site.id %>"
                      title="Supprimer"
                      class="typo-btn-small"
                      style="background-color: #dc2626; color: white; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 4px; padding: 6px 10px; border-radius: 6px; font-size: 0.813rem; font-weight: 600; transition: background-color 0.2s;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                      Supprimer
                    </button>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <div style="text-align: center; padding: var(--space-xxl); background-color: #f8f9fa; border-radius: var(--space-md);">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin: 0 auto var(--space-lg); color: #ccc;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
          <h3 class="typo-h3" style="margin-bottom: var(--space-sm); color: #666;">Aucun site pour le moment</h3>
          <p class="typo-body-small" style="color: #999; margin-bottom: var(--space-lg);">Commencez par créer votre premier site</p>
          <%= link_to new_site_path, class: "typo-btn-success" do %>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Créer un site
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Pagination -->
    <div style="margin-top: var(--space-xl);">
      <%= render 'shared/pagination', 
        current_page: @sites.current_page, 
        total_pages: @sites.total_pages, 
        total_count: @sites.total_count, 
        per_page: 10,
        path: sites_path %>
    </div>
  </div>
  
  <!-- Deletion Confirmation Modals -->
  <% @sites.each do |site| %>
    <%= render 'shared/deletion_confirmation_modal',
      entity_type: 'le site',
      entity_name: "#{site.name} - #{site.city}",
      entity_id: "site-#{site.id}",
      affected_items: { 
        'bâtiments' => site.buildings_count, 
        'équipements' => 0, 
        'contrats' => 0
      },
      requires_extra_confirmation: true,
      delete_path: site_path(site)
    %>
  <% end %>
</div>

<!-- Initialize deletion confirmation controller -->
<div data-controller="deletion-confirmation"></div>
