<% content_for :header, "Validation du Contrat" %>

<div class="section">
  <div style="margin-bottom: var(--space-lg);">
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div>
        <h2 class="typo-h2" style="margin-bottom: var(--space-xs);">Validation de l'extraction</h2>
        <p class="typo-body-small" style="color: var(--gray-secondary);">Contrat N° <%= @contract.contract_number %></p>
      </div>
      <div style="display: flex; gap: var(--space-md);">
        <%= link_to contracts_path, class: "typo-btn-cancel" do %>
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
          Retour
        <% end %>
      </div>
    </div>
  </div>

  <!-- Two-Panel Layout -->
  <div style="display: grid; grid-template-columns: 60% 40%; gap: var(--space-lg); min-height: 80vh;">
    
    <!-- LEFT PANEL: PDF Viewer -->
    <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-md); box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
      <!-- PDF Controls -->
      <div style="display: flex; justify-content: center; align-items: center; gap: var(--space-lg); padding: var(--space-md); border-bottom: 1px solid var(--light-gray); margin-bottom: var(--space-md);">
        <button type="button" style="background: none; border: none; cursor: pointer; padding: var(--space-xs);">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
          </svg>
        </button>
        <span class="typo-body-small" style="color: var(--gray-secondary);">181 %</span>
        <button type="button" style="background: none; border: none; cursor: pointer; padding: var(--space-xs);">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
        </button>
        <span class="typo-body-small" style="margin-left: var(--space-lg); color: var(--gray-secondary);">Page 1 / 26</span>
      </div>

      <!-- PDF Display Area -->
      <div style="flex: 1; background-color: #f5f5f5; border-radius: var(--space-sm); overflow: auto; display: flex; align-items: center; justify-content: center;">
        <img src="<%= @contract.pdf_url %>" alt="Contract PDF" style="max-width: 100%; height: auto; border-radius: var(--space-sm);" />
      </div>
    </div>

    <!-- RIGHT PANEL: Extracted Fields -->
    <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-lg); box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: flex; flex-direction: column; max-height: 80vh;">
      <!-- Header -->
      <div style="margin-bottom: var(--space-lg);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-md);">
          <h3 class="typo-h3">Champs généraux</h3>
          <span class="typo-body-small typo-bold" style="color: var(--coral-primary);">
            Score de confiance: 0.99
          </span>
        </div>
        
        <!-- Search Box -->
        <div style="position: relative;">
          <input 
            type="text" 
            placeholder="Rechercher"
            style="width: 100%; padding: 10px 40px 10px 12px; border: 1px solid var(--light-gray); border-radius: var(--space-sm); font-size: 0.875rem;"
          />
          <svg 
            xmlns="http://www.w3.org/2000/svg" 
            width="18" 
            height="18" 
            fill="none" 
            viewBox="0 0 24 24" 
            stroke="currentColor"
            style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-secondary);"
          >
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
      </div>

      <!-- Scrollable Fields List -->
      <div style="flex: 1; overflow-y: auto; margin-bottom: var(--space-lg);">
        <% @extracted_fields.each do |field| %>
          <% 
            # Determine confidence color
            if field[:confidence] >= 0.95
              confidence_bg = "#d4edda"
              confidence_color = "#155724"
            elsif field[:confidence] >= 0.80
              confidence_bg = "#fff3cd"
              confidence_color = "#856404"
            else
              confidence_bg = "#f8d7da"
              confidence_color = "#721c24"
            end
          %>
          
          <div style="background-color: #ffffff; border: 1px solid #e0e0e0; border-radius: var(--space-sm); padding: var(--space-md); margin-bottom: var(--space-md);">
            <!-- Field Header -->
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--space-xs);">
              <p class="typo-body-small typo-bold" style="color: var(--gray-secondary); margin: 0;">
                <%= field[:label] %>
              </p>
              <span 
                style="display: inline-block; padding: 2px 8px; background-color: <%= confidence_bg %>; color: <%= confidence_color %>; border-radius: 12px; font-size: 0.75rem; font-weight: 600; white-space: nowrap; margin-left: var(--space-sm);"
              >
                <%= sprintf("%.2f", field[:confidence]) %>
              </span>
            </div>
            
            <!-- Field Value -->
            <p class="typo-body-small" style="color: #333; margin: 0; line-height: 1.5;">
              <%= field[:value] %>
            </p>
          </div>
        <% end %>
      </div>

      <!-- Action Buttons -->
      <div style="border-top: 1px solid var(--light-gray); padding-top: var(--space-lg);">
        <div style="display: flex; gap: var(--space-md);">
          <%= link_to validate_contract_path(@contract.id), method: :patch, class: "typo-btn-success", style: "flex: 1; text-align: center; display: inline-flex; align-items: center; justify-content: center; gap: var(--space-sm);" do %>
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
            </svg>
            Valider
          <% end %>
          <%= link_to contracts_path, class: "typo-btn-cancel", style: "flex: 1; text-align: center;" do %>
            Annuler
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Responsive Styles -->
<style>
  @media (max-width: 1200px) {
    div[style*="grid-template-columns: 60% 40%"] {
      grid-template-columns: 1fr !important;
    }
  }
</style>
