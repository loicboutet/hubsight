<% content_for :header, "Validation du Contrat" %>

<div class="section">
  <!-- Breadcrumb Navigation -->
  <div style="margin-bottom: var(--space-xl);">
    <%= render 'shared/breadcrumb', path: [
      { name: 'Contrats', url: contracts_path },
      { name: @contract.contract_number, url: contract_path(@contract) },
      { name: 'Validation', url: nil }
    ] %>
  </div>

  <!-- Header -->
  <div style="margin-bottom: var(--space-xl); display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h2 class="typo-h2" style="margin-bottom: var(--space-sm);">Validation des Donn√©es Extraites</h2>
      <p class="typo-body-small">Contrat N¬∞ <%= @contract.contract_number %></p>
      <% if @contract.pdf_attached? %>
        <p class="typo-body-small" style="margin-top: var(--space-xs);">
          <%= link_to "üìÑ Voir le PDF", rails_blob_path(@contract.pdf_document, disposition: "inline"), 
              target: "_blank", 
              class: "typo-link" %>
        </p>
      <% end %>
    </div>
    <div>
      <%= link_to contract_path(@contract), class: "typo-btn-cancel" do %>
        ‚Üê Retour
      <% end %>
    </div>
  </div>

  <!-- Validation Banner -->
  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: var(--space-lg); border-radius: var(--space-md); margin-bottom: var(--space-xl);">
    <div style="display: flex; align-items: center; gap: var(--space-md);">
      <span style="font-size: 2rem;">‚úì</span>
      <div>
        <h3 style="margin: 0; font-size: 1.25rem;">Comparez et approuvez les donn√©es</h3>
        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Comparez les valeurs originales (saisie manuelle) avec les valeurs extraites par l'IA. Modifiez si n√©cessaire.</p>
      </div>
    </div>
  </div>

  <%= form_with model: @contract, url: confirm_validation_contract_path(@contract), method: :post do |f| %>
    
    <!-- Validation Form -->
    <div style="background: white; border-radius: var(--space-md); padding: var(--space-lg); margin-bottom: var(--space-lg);">
      
      <!-- Help Text -->
      <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: var(--space-md); margin-bottom: var(--space-lg); border-radius: var(--space-sm);">
        <p class="typo-body-small" style="color: #0d47a1; margin: 0;">
          üí° <strong>Comment utiliser:</strong> Comparez les valeurs de chaque champ. Le champ de droite (Valeur Finale) est pr√©-rempli avec la valeur extraite par l'IA si disponible, sinon avec votre valeur originale. Modifiez la valeur finale si n√©cessaire.
        </p>
      </div>

      <% Contract.validation_fields.each do |category, fields| %>
        <% 
          category_titles = {
            identification: 'üìã Identification',
            stakeholders: 'üë• Parties Prenantes',
            scope: 'üéØ P√©rim√®tre',
            financial: 'üí∞ Aspects Financiers',
            temporality: 'üìÖ Temporalit√©',
            services: 'üîß Services & SLA'
          }
        %>
        
        <!-- CATEGORY -->
        <details open style="border: 1px solid #e5e7eb; border-radius: var(--space-md); margin-bottom: var(--space-lg); padding: var(--space-md);">
          <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: var(--space-sm); user-select: none;">
            <%= category_titles[category] %> (<%= fields.count %> champs)
          </summary>
          
          <div style="margin-top: var(--space-md);">
            <!-- Comparison Table -->
            <table style="width: 100%; border-collapse: collapse; margin-top: var(--space-md);">
              <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                  <th style="padding: var(--space-sm); text-align: left; width: 25%; font-size: 0.9rem; color: #6c757d;">Champ</th>
                  <th style="padding: var(--space-sm); text-align: left; width: 30%; font-size: 0.9rem; color: #6c757d;">Valeur Originale</th>
                  <th style="padding: var(--space-sm); text-align: left; width: 30%; font-size: 0.9rem; color: #6c757d;">Valeur Extraite (IA)</th>
                  <th style="padding: var(--space-sm); text-align: left; width: 15%; font-size: 0.9rem; color: #6c757d; text-align: center;">Action</th>
                </tr>
              </thead>
              <tbody>
                <% fields.each do |field| %>
                  <% 
                    original = @contract.original_value(field)
                    extracted = @contract.extracted_value(field)
                    has_extracted = @contract.has_extracted_value?(field)
                    
                    # Get field type for normalization
                    field_type = @contract.class.columns_hash[field.to_s]&.type
                    
                    # Normalize values for accurate comparison (handles dates, booleans, etc.)
                    normalized_original = normalize_value_for_comparison(original, field_type)
                    normalized_extracted = normalize_value_for_comparison(extracted, field_type)
                    
                    # Check if values are actually different after normalization
                    values_differ = has_extracted && (normalized_extracted != normalized_original)
                    
                    # Determine which value to use as default (prefer extracted if available)
                    default_value = has_extracted ? extracted : original
                    
                    # Field labels in French
                    field_labels = {
                      title: 'Titre',
                      contract_type: 'Type de contrat',
                      purchase_subfamily: 'Sous-famille d\'achats',
                      contract_object: 'Objet du contrat',
                      detailed_description: 'Description d√©taill√©e',
                      contracting_method: 'Mode de passation',
                      public_reference: 'R√©f√©rence publique',
                      contractor_organization_name: 'Prestataire (Organisation)',
                      contractor_contact_name: 'Contact prestataire',
                      contractor_agency_name: 'Agence prestataire',
                      client_organization_name: 'Client (Organisation)',
                      client_contact_name: 'Contact client',
                      managing_department: 'D√©partement gestionnaire',
                      monitoring_manager: 'Responsable suivi',
                      contractor_phone: 'T√©l√©phone prestataire',
                      contractor_email: 'Email prestataire',
                      client_contact_email: 'Email contact client',
                      equipment_count: 'Nombre d\'√©quipements',
                      geographic_areas: 'Zones g√©ographiques',
                      building_names: 'Noms des b√¢timents',
                      floor_levels: 'Niveaux/√âtages',
                      specific_zones: 'Zones sp√©cifiques',
                      technical_lot: 'Lot technique',
                      equipment_categories: 'Cat√©gories √©quipements',
                      coverage_description: 'Description p√©rim√®tre',
                      annual_amount_ht: 'Montant annuel HT (‚Ç¨)',
                      annual_amount_ttc: 'Montant annuel TTC (‚Ç¨)',
                      monthly_amount: 'Montant mensuel (‚Ç¨)',
                      billing_method: 'M√©thode facturation',
                      billing_frequency: 'Fr√©quence facturation',
                      payment_terms: 'Conditions de paiement',
                      revision_conditions: 'Conditions r√©vision',
                      revision_index: 'Indice de r√©vision',
                      revision_frequency: 'Fr√©quence r√©vision',
                      budget_code: 'Code budg√©taire',
                      signature_date: 'Date de signature',
                      execution_start_date: 'Date d√©but ex√©cution',
                      initial_duration_months: 'Dur√©e initiale (mois)',
                      renewal_duration_months: 'Dur√©e renouvellement (mois)',
                      renewal_count: 'Nombre de renouvellements',
                      automatic_renewal: 'Renouvellement automatique',
                      notice_period_days: 'Pr√©avis (jours)',
                      next_deadline_date: 'Prochaine √©ch√©ance',
                      service_nature: 'Nature des services',
                      intervention_frequency: 'Fr√©quence intervention',
                      intervention_delay_hours: 'D√©lai intervention (h)',
                      resolution_delay_hours: 'D√©lai r√©solution (h)',
                      working_hours: 'Horaires de travail',
                      on_call_24_7: 'Astreinte 24/7',
                      sla_percentage: 'SLA (%)',
                      spare_parts_included: 'Pi√®ces incluses'
                    }
                  %>
                  
                  <tr style="border-bottom: 1px solid #e9ecef;">
                    <!-- Field Name -->
                    <td style="padding: var(--space-md); vertical-align: top; font-weight: 500; color: #495057;">
                      <%= field_labels[field] || field.to_s.humanize %>
                    </td>
                    
                    <!-- Original Value -->
                    <td style="padding: var(--space-md); vertical-align: top;">
                      <div style="background: #f8f9fa; padding: var(--space-sm); border-radius: var(--space-xs); min-height: 2rem; display: flex; align-items: center;">
                        <span style="color: #6c757d; font-size: 0.9rem;">
                          <% if original.present? %>
                            <%= original.is_a?(TrueClass) || original.is_a?(FalseClass) ? (original ? 'Oui' : 'Non') : original %>
                          <% else %>
                            <em style="color: #ced4da;">(vide)</em>
                          <% end %>
                        </span>
                      </div>
                    </td>
                    
                    <!-- Extracted Value -->
                    <td style="padding: var(--space-md); vertical-align: top;">
                      <div style="background: <%= has_extracted ? '#d4edda' : '#f8f9fa' %>; padding: var(--space-sm); border-radius: var(--space-xs); min-height: 2rem; display: flex; align-items: center;">
                        <span style="color: <%= has_extracted ? '#155724' : '#6c757d' %>; font-size: 0.9rem;">
                          <% if has_extracted %>
                            <%= extracted.is_a?(TrueClass) || extracted.is_a?(FalseClass) ? (extracted ? 'Oui' : 'Non') : extracted %>
                          <% else %>
                            <em style="color: #ced4da;">(non extrait)</em>
                          <% end %>
                        </span>
                      </div>
                    </td>
                    
                    <!-- Action Button -->
                    <td style="padding: var(--space-md); vertical-align: top; text-align: center;">
                      <% if values_differ %>
                        <button type="button"
                                class="typo-btn-small typo-btn-small-success use-extracted-btn"
                                data-field="<%= field %>"
                                data-value="<%= extracted %>"
                                data-contract-id="<%= @contract.id %>"
                                title="Utiliser la valeur extraite par l'IA">
                          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                          </svg>
                          Utiliser IA
                        </button>
                      <% else %>
                        <span style="color: #ced4da; font-size: 0.85rem;">‚Äî</span>
                      <% end %>
                    </td>
                  </tr>
                  
                  <!-- Editable Row (Valeur Finale) -->
                  <tr style="background: #fff;">
                    <td colspan="4" style="padding: var(--space-sm) var(--space-md);">
                      <div style="display: flex; align-items: center; gap: var(--space-sm);">
                        <label style="font-weight: 500; color: #495057; min-width: 120px; font-size: 0.9rem;">
                          ‚Üí Valeur Finale:
                        </label>
                        <div style="flex: 1;">
                          <%
                            field_type = @contract.class.columns_hash[field.to_s]&.type
                          %>
                          
                          <% case field_type %>
                          <% when :text %>
                            <%= f.text_area field, 
                                value: default_value,
                                rows: 2,
                                class: "typo-input final-value-field",
                                style: "width: 100%; font-size: 0.9rem;",
                                data: { field: field } %>
                          <% when :boolean %>
                            <%= f.select field,
                                [['Oui', true], ['Non', false]],
                                { selected: default_value },
                                class: "typo-input final-value-field",
                                style: "width: 150px; font-size: 0.9rem;",
                                data: { field: field } %>
                          <% when :date %>
                            <%= f.date_field field,
                                value: default_value,
                                class: "typo-input final-value-field",
                                style: "width: 200px; font-size: 0.9rem;",
                                data: { field: field } %>
                          <% when :integer, :decimal %>
                            <%= f.number_field field,
                                value: default_value,
                                step: field_type == :decimal ? 0.01 : 1,
                                class: "typo-input final-value-field",
                                style: "width: 200px; font-size: 0.9rem;",
                                data: { field: field } %>
                          <% else %>
                            <%= f.text_field field,
                                value: default_value,
                                class: "typo-input final-value-field",
                                style: "width: 100%; font-size: 0.9rem;",
                                data: { field: field } %>
                          <% end %>
                        </div>
                      </div>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>
        </details>
      <% end %>

      <!-- Validation Notes -->
      <div style="margin-top: var(--space-xl);">
        <label class="typo-label">Notes de validation (optionnel)</label>
        <%= f.text_area :validation_notes, 
            rows: 4, 
            class: "typo-input", 
            placeholder: "Ajoutez des notes concernant cette validation...",
            style: "width: 100%;" %>
      </div>

      <!-- Action Buttons -->
      <div style="margin-top: var(--space-xl); display: flex; gap: var(--space-md); justify-content: flex-end;">
        <%= link_to contract_path(@contract), class: "typo-btn-cancel", style: "display: inline-flex; align-items: center; gap: var(--space-sm);" do %>
          Annuler
        <% end %>
        <%= f.submit "‚úì Valider le Contrat", 
            class: "typo-btn-success", 
            style: "cursor: pointer; display: inline-flex; align-items: center; gap: var(--space-sm);" %>
      </div>
    </div>
  <% end %>
</div>

<!-- JavaScript for "Use AI" buttons -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Get CSRF token for AJAX requests
  const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
  
  // Handle "Use AI" button clicks
  document.querySelectorAll('.use-extracted-btn').forEach(button => {
    button.addEventListener('click', function() {
      const field = this.dataset.field;
      const value = this.dataset.value;
      const contractId = this.dataset.contractId;
      const btn = this;
      
      // Find the corresponding final value field
      const finalField = document.querySelector(`[data-field="${field}"].final-value-field`);
      
      if (finalField) {
        // Update the input field
        finalField.value = value;
        
        // Disable button and show loading state
        btn.disabled = true;
        btn.textContent = '‚è≥ Sauvegarde...';
        
        // Prepare data to send
        const formData = new FormData();
        formData.append('field', field);
        formData.append('value', value);
        
        // Send AJAX request to save immediately
        fetch(`/contracts/${contractId}/apply_ai_value`, {
          method: 'PATCH',
          headers: {
            'X-CSRF-Token': csrfToken,
            'Accept': 'application/json'
          },
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Highlight the field temporarily
            finalField.style.background = '#d4edda';
            setTimeout(() => {
              finalField.style.background = '';
            }, 1000);
            
            // Update button to success state
            btn.textContent = '‚úì Appliqu√©';
            btn.style.background = '#6c757d';
            
            // Show success message
            console.log(`‚úì ${field} sauvegard√© avec succ√®s`);
          } else {
            // Show error
            alert('Erreur: ' + (data.error || 'Impossible de sauvegarder'));
            btn.disabled = false;
            btn.textContent = '‚úì Utiliser IA';
          }
        })
        .catch(error => {
          console.error('Erreur AJAX:', error);
          alert('Erreur de connexion. Veuillez r√©essayer.');
          btn.disabled = false;
          btn.textContent = '‚úì Utiliser IA';
        });
      }
    });
  });
});
</script>
