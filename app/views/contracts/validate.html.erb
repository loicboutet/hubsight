<% content_for :header, "Validation du Contrat" %>

<div class="section">
  <!-- Header -->
  <div style="margin-bottom: var(--space-xl); display: flex; justify-content: space-between; align-items: center;">
    <div>
      <h2 class="typo-h2" style="margin-bottom: var(--space-sm);">Validation des Donn√©es Extraites</h2>
      <p class="typo-body-small">Contrat N¬∞ <%= @contract.contract_number %></p>
    </div>
    <div>
      <%= link_to contract_path(@contract), class: "typo-btn-cancel" do %>
        ‚Üê Retour
      <% end %>
    </div>
  </div>

  <!-- Validation Status Banner -->
  <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: var(--space-lg); border-radius: var(--space-md); margin-bottom: var(--space-xl);">
    <div style="display: flex; align-items: center; gap: var(--space-md);">
      <span style="font-size: 2rem;">‚úì</span>
      <div>
        <h3 style="margin: 0; font-size: 1.25rem;">Validation Manuelle Requise</h3>
        <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">V√©rifiez les donn√©es extraites automatiquement et corrigez si n√©cessaire avant de valider</p>
      </div>
    </div>
  </div>

  <!-- Split Screen Layout -->
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xl); margin-bottom: var(--space-xl);">
    
    <!-- LEFT: PDF Viewer -->
    <div style="position: sticky; top: 20px; height: calc(100vh - 40px);">
      <div style="background: white; border-radius: var(--space-md); padding: var(--space-lg); height: 100%; display: flex; flex-direction: column;">
        <h3 class="typo-h4" style="margin-bottom: var(--space-md); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
          üìÑ Document PDF Original
        </h3>
        
        <% if @contract.pdf_attached? %>
          <div style="flex: 1; overflow: auto; background: #f5f5f5; border-radius: var(--space-sm); padding: var(--space-md);">
            <iframe 
              src="<%= rails_blob_path(@contract.pdf_document, disposition: "inline") %>" 
              style="width: 100%; height: 100%; border: none; border-radius: var(--space-sm);"
              title="Contract PDF">
            </iframe>
          </div>
        <% else %>
          <div style="flex: 1; display: flex; align-items: center; justify-content: center; background: #f5f5f5; border-radius: var(--space-sm);">
            <div style="text-align: center; color: #999;">
              <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin: 0 auto 1rem;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
              </svg>
              <p style="font-size: 1.1rem; color: #666;">Aucun PDF disponible</p>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- RIGHT: Validation Form -->
    <div>
      <%= form_with model: @contract, url: confirm_validation_contract_path(@contract), method: :post, data: { controller: "validation" } do |f| %>
        
        <div style="background: white; border-radius: var(--space-md); padding: var(--space-lg); margin-bottom: var(--space-lg);">
          <h3 class="typo-h4" style="margin-bottom: var(--space-md); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
            ‚úèÔ∏è Donn√©es √âditables
          </h3>
          
          <!-- Help Text -->
          <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: var(--space-md); margin-bottom: var(--space-lg); border-radius: var(--space-sm);">
            <p class="typo-body-small" style="color: #0d47a1; margin: 0;">
              üí° <strong>Astuce:</strong> Les champs avec fond vert ont √©t√© extraits automatiquement. Les champs avec fond rouge sont vides. V√©rifiez et corrigez les donn√©es avant de valider.
            </p>
          </div>

          <!-- CATEGORY 1: IDENTIFICATION -->
          <details open style="border: 1px solid #e5e7eb; border-radius: var(--space-md); margin-bottom: var(--space-lg); padding: var(--space-md);">
            <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: var(--space-sm); user-select: none;">
              üìã Identification (8 champs)
            </summary>
            <div style="margin-top: var(--space-md); display: grid; gap: var(--space-md);">
              
              <div>
                <label class="typo-label">Titre</label>
                <%= f.text_field :title, class: "typo-input", style: field_style(@contract.title), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Objet du contrat</label>
                <%= f.text_area :contract_object, rows: 3, class: "typo-input", style: field_style(@contract.contract_object), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Type de contrat</label>
                <%= f.text_field :contract_type, class: "typo-input", style: field_style(@contract.contract_type), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Sous-famille d'achats</label>
                <%= f.text_field :purchase_subfamily, class: "typo-input", style: field_style(@contract.purchase_subfamily), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Description d√©taill√©e</label>
                <%= f.text_area :detailed_description, rows: 3, class: "typo-input", style: field_style(@contract.detailed_description), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Mode de passation</label>
                <%= f.text_field :contracting_method, class: "typo-input", style: field_style(@contract.contracting_method), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">R√©f√©rence publique</label>
                <%= f.text_field :public_reference, class: "typo-input", style: field_style(@contract.public_reference), data: { validation_target: "field" } %>
              </div>
            </div>
          </details>

          <!-- CATEGORY 2: STAKEHOLDERS -->
          <details style="border: 1px solid #e5e7eb; border-radius: var(--space-md); margin-bottom: var(--space-lg); padding: var(--space-md);">
            <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: var(--space-sm); user-select: none;">
              üë• Parties Prenantes (10 champs)
            </summary>
            <div style="margin-top: var(--space-md); display: grid; gap: var(--space-md);">
              
              <div>
                <label class="typo-label">Prestataire (Organisation)</label>
                <%= f.text_field :contractor_organization_name, class: "typo-input", style: field_style(@contract.contractor_organization_name), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Contact prestataire</label>
                <%= f.text_field :contractor_contact_name, class: "typo-input", style: field_style(@contract.contractor_contact_name), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Agence prestataire</label>
                <%= f.text_field :contractor_agency_name, class: "typo-input", style: field_style(@contract.contractor_agency_name), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Client (Organisation)</label>
                <%= f.text_field :client_organization_name, class: "typo-input", style: field_style(@contract.client_organization_name), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Contact client</label>
                <%= f.text_field :client_contact_name, class: "typo-input", style: field_style(@contract.client_contact_name), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">D√©partement gestionnaire</label>
                <%= f.text_field :managing_department, class: "typo-input", style: field_style(@contract.managing_department), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Responsable suivi</label>
                <%= f.text_field :monitoring_manager, class: "typo-input", style: field_style(@contract.monitoring_manager), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">T√©l√©phone prestataire</label>
                <%= f.text_field :contractor_phone, class: "typo-input", style: field_style(@contract.contractor_phone), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Email prestataire</label>
                <%= f.email_field :contractor_email, class: "typo-input", style: field_style(@contract.contractor_email), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Email contact client</label>
                <%= f.email_field :client_contact_email, class: "typo-input", style: field_style(@contract.client_contact_email), data: { validation_target: "field" } %>
              </div>
            </div>
          </details>

          <!-- CATEGORY 3: SCOPE -->
          <details style="border: 1px solid #e5e7eb; border-radius: var(--space-md); margin-bottom: var(--space-lg); padding: var(--space-md);">
            <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: var(--space-sm); user-select: none;">
              üéØ P√©rim√®tre (8 champs s√©lectionn√©s)
            </summary>
            <div style="margin-top: var(--space-md); display: grid; gap: var(--space-md);">
              
              <div>
                <label class="typo-label">Nombre d'√©quipements</label>
                <%= f.number_field :equipment_count, class: "typo-input", style: field_style(@contract.equipment_count), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Zones g√©ographiques</label>
                <%= f.text_field :geographic_areas, class: "typo-input", style: field_style(@contract.geographic_areas), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Noms des b√¢timents</label>
                <%= f.text_field :building_names, class: "typo-input", style: field_style(@contract.building_names), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Niveaux/√âtages</label>
                <%= f.text_field :floor_levels, class: "typo-input", style: field_style(@contract.floor_levels), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Zones sp√©cifiques</label>
                <%= f.text_field :specific_zones, class: "typo-input", style: field_style(@contract.specific_zones), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Lot technique</label>
                <%= f.text_field :technical_lot, class: "typo-input", style: field_style(@contract.technical_lot), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Cat√©gories √©quipements</label>
                <%= f.text_field :equipment_categories, class: "typo-input", style: field_style(@contract.equipment_categories), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Description p√©rim√®tre</label>
                <%= f.text_area :coverage_description, rows: 3, class: "typo-input", style: field_style(@contract.coverage_description), data: { validation_target: "field" } %>
              </div>
            </div>
          </details>

          <!-- CATEGORY 4: FINANCIAL -->
          <details style="border: 1px solid #e5e7eb; border-radius: var(--space-md); margin-bottom: var(--space-lg); padding: var(--space-md);">
            <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: var(--space-sm); user-select: none;">
              üí∞ Aspects Financiers (10 champs s√©lectionn√©s)
            </summary>
            <div style="margin-top: var(--space-md); display: grid; gap: var(--space-md);">
              
              <div>
                <label class="typo-label">Montant annuel HT (‚Ç¨)</label>
                <%= f.number_field :annual_amount_ht, step: 0.01, class: "typo-input", style: field_style(@contract.annual_amount_ht), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Montant annuel TTC (‚Ç¨)</label>
                <%= f.number_field :annual_amount_ttc, step: 0.01, class: "typo-input", style: field_style(@contract.annual_amount_ttc), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Montant mensuel (‚Ç¨)</label>
                <%= f.number_field :monthly_amount, step: 0.01, class: "typo-input", style: field_style(@contract.monthly_amount), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">M√©thode facturation</label>
                <%= f.text_field :billing_method, class: "typo-input", style: field_style(@contract.billing_method), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Fr√©quence facturation</label>
                <%= f.text_field :billing_frequency, class: "typo-input", style: field_style(@contract.billing_frequency), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Conditions de paiement</label>
                <%= f.text_field :payment_terms, class: "typo-input", style: field_style(@contract.payment_terms), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Conditions r√©vision</label>
                <%= f.text_area :revision_conditions, rows: 2, class: "typo-input", style: field_style(@contract.revision_conditions), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Indice de r√©vision</label>
                <%= f.text_field :revision_index, class: "typo-input", style: field_style(@contract.revision_index), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Fr√©quence r√©vision</label>
                <%= f.text_field :revision_frequency, class: "typo-input", style: field_style(@contract.revision_frequency), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Code budg√©taire</label>
                <%= f.text_field :budget_code, class: "typo-input", style: field_style(@contract.budget_code), data: { validation_target: "field" } %>
              </div>
            </div>
          </details>

          <!-- CATEGORY 5: TEMPORALITY -->
          <details style="border: 1px solid #e5e7eb; border-radius: var(--space-md); margin-bottom: var(--space-lg); padding: var(--space-md);">
            <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: var(--space-sm); user-select: none;">
              üìÖ Temporalit√© (8 champs s√©lectionn√©s)
            </summary>
            <div style="margin-top: var(--space-md); display: grid; gap: var(--space-md);">
              
              <div>
                <label class="typo-label">Date de signature</label>
                <%= f.date_field :signature_date, class: "typo-input", style: field_style(@contract.signature_date), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Date d√©but ex√©cution</label>
                <%= f.date_field :execution_start_date, class: "typo-input", style: field_style(@contract.execution_start_date), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Dur√©e initiale (mois)</label>
                <%= f.number_field :initial_duration_months, class: "typo-input", style: field_style(@contract.initial_duration_months), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Dur√©e renouvellement (mois)</label>
                <%= f.number_field :renewal_duration_months, class: "typo-input", style: field_style(@contract.renewal_duration_months), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Nombre de renouvellements</label>
                <%= f.number_field :renewal_count, class: "typo-input", style: field_style(@contract.renewal_count), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Renouvellement automatique</label>
                <%= f.select :automatic_renewal, [['Oui', true], ['Non', false]], {}, class: "typo-input", style: field_style(@contract.automatic_renewal), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Pr√©avis (jours)</label>
                <%= f.number_field :notice_period_days, class: "typo-input", style: field_style(@contract.notice_period_days), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Prochaine √©ch√©ance</label>
                <%= f.date_field :next_deadline_date, class: "typo-input", style: field_style(@contract.next_deadline_date), data: { validation_target: "field" } %>
              </div>
            </div>
          </details>

          <!-- CATEGORY 6: SERVICES & SLA -->
          <details style="border: 1px solid #e5e7eb; border-radius: var(--space-md); margin-bottom: var(--space-lg); padding: var(--space-md);">
            <summary style="cursor: pointer; font-weight: 600; font-size: 1.1rem; padding: var(--space-sm); user-select: none;">
              üîß Services & SLA (8 champs s√©lectionn√©s)
            </summary>
            <div style="margin-top: var(--space-md); display: grid; gap: var(--space-md);">
              
              <div>
                <label class="typo-label">Nature des services</label>
                <%= f.text_area :service_nature, rows: 3, class: "typo-input", style: field_style(@contract.service_nature), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Fr√©quence intervention</label>
                <%= f.text_field :intervention_frequency, class: "typo-input", style: field_style(@contract.intervention_frequency), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">D√©lai intervention (h)</label>
                <%= f.number_field :intervention_delay_hours, class: "typo-input", style: field_style(@contract.intervention_delay_hours), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">D√©lai r√©solution (h)</label>
                <%= f.number_field :resolution_delay_hours, class: "typo-input", style: field_style(@contract.resolution_delay_hours), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Horaires de travail</label>
                <%= f.text_field :working_hours, class: "typo-input", style: field_style(@contract.working_hours), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Astreinte 24/7</label>
                <%= f.select :on_call_24_7, [['Oui', true], ['Non', false]], {}, class: "typo-input", style: field_style(@contract.on_call_24_7), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">SLA (%)</label>
                <%= f.number_field :sla_percentage, step: 0.1, class: "typo-input", style: field_style(@contract.sla_percentage), data: { validation_target: "field" } %>
              </div>

              <div>
                <label class="typo-label">Pi√®ces incluses</label>
                <%= f.select :spare_parts_included, [['Oui', true], ['Non', false]], {}, class: "typo-input", style: field_style(@contract.spare_parts_included), data: { validation_target: "field" } %>
              </div>
            </div>
          </details>

          <!-- Validation Notes -->
          <div style="margin-top: var(--space-xl);">
            <label class="typo-label">Notes de validation (optionnel)</label>
            <%= f.text_area :validation_notes, rows: 4, class: "typo-input", placeholder: "Ajoutez des notes concernant cette validation..." %>
          </div>

          <!-- Action Buttons -->
          <div style="margin-top: var(--space-xl); display: flex; gap: var(--space-md); justify-content: flex-end;">
            <%= link_to contract_path(@contract), class: "typo-btn-cancel" do %>
              Annuler
            <% end %>
            <%= f.submit "‚úì Valider le Contrat", class: "typo-btn-primary", style: "background: linear-gradient(135deg, #10b981 0%, #059669 100%);" %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>

<% content_for :javascript do %>
  <script>
    // Helper function to determine field background color
    function field_style(value) {
      if (value && value !== '') {
        return 'background-color: #f0fdf4; border: 2px solid #10b981;'; // Green for populated
      } else {
        return 'background-color: #fef2f2; border: 2px solid #ef4444;'; // Red for empty
      }
    }
  </script>
<% end %>

<%
  # Helper method to determine field style based on whether it has a value
  def field_style(value)
    if value.present?
      "background-color: #f0fdf4; border: 2px solid #10b981;" # Green
    else
      "background-color: #fef2f2; border: 2px solid #ef4444;" # Red
    end
  end
%>
