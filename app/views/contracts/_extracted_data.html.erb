<% # Display extracted contract data from LLM %>
<% if @contract.extraction_completed? || @contract.extraction_in_progress? || @contract.extraction_failed? %>
  <div style="margin-top: 2rem;">
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 8px 8px 0 0;">
      <h2 style="margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
        <span>ü§ñ</span>
        <span>Donn√©es Extraites Automatiquement</span>
        <span style="display: inline-block; padding: 0.25rem 0.75rem; background: <%= @contract.extraction_status_badge_color %>; color: white; border-radius: 12px; font-size: 0.875rem; font-weight: 600;">
          <%= @contract.extraction_status_display %>
        </span>
      </h2>
    </div>

    <div style="background: white; border: 1px solid #e5e7eb; border-top: none; padding: 1.5rem; border-radius: 0 0 8px 8px;">
      
      <% if @contract.using_demo_extraction? %>
        <div style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 1rem;">
          <span style="font-size: 2rem;">üé≠</span>
          <div>
            <div style="font-weight: 600; font-size: 1.1rem; margin-bottom: 0.25rem;">Mode D√©monstration</div>
            <div style="font-size: 0.875rem; opacity: 0.95;">
              Extraction par expressions r√©guli√®res (gratuite). Pour activer l'extraction LLM r√©elle avec OpenRouter, ajoutez la cl√© API dans les credentials Rails.
            </div>
          </div>
        </div>
      <% end %>

      <!-- Extraction Metadata -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; padding: 1rem; background: #f9fafb; border-radius: 8px;">
        <div>
          <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Fournisseur</div>
          <div style="font-weight: 600;"><%= @contract.extraction_provider&.titleize || 'N/A' %></div>
        </div>
        <div>
          <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Mod√®le</div>
          <div style="font-weight: 600;"><%= @contract.extraction_model || 'N/A' %></div>
        </div>
        <div>
          <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Confiance</div>
          <div style="font-weight: 600;"><%= @contract.extraction_confidence_percent %></div>
        </div>
        <div>
          <div style="font-size: 0.75rem; color: #6b7280; text-transform: uppercase; margin-bottom: 0.25rem;">Trait√© le</div>
          <div style="font-weight: 600;"><%= @contract.extraction_processed_at&.strftime('%d/%m/%Y %H:%M') || 'N/A' %></div>
        </div>
      </div>

      <% if @contract.extraction_notes.present? %>
        <div style="background: #eff6ff; border-left: 4px solid #3b82f6; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
          <div style="color: #1e40af; font-size: 0.875rem;"><%= @contract.extraction_notes %></div>
        </div>
      <% end %>

      <% if @contract.extraction_failed? %>
        <div style="background: #fef2f2; border-left: 4px solid #ef4444; padding: 1rem; margin-bottom: 2rem; border-radius: 4px;">
          <div style="color: #991b1b; font-weight: 600; margin-bottom: 0.5rem;">‚ùå √âchec de l'extraction</div>
          <div style="color: #7f1d1d; font-size: 0.875rem;"><%= @contract.extraction_notes %></div>
          <%= button_to 'üîÑ Relancer l\'extraction', retry_extraction_contract_path(@contract), method: :post, class: 'btn btn-secondary', style: 'margin-top: 1rem;' %>
        </div>
      <% end %>

      <% if @contract.extraction_completed? %>
        <!-- Category tabs/sections -->
        <div style="margin-top: 2rem;">
          
          <!-- CATEGORY 1: IDENTIFICATION -->
          <details open style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
            <summary style="background: #f9fafb; padding: 1rem; cursor: pointer; font-weight: 600; border-radius: 8px; user-select: none;">
              üìã Identification (8 champs)
            </summary>
            <div style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Num√©ro de contrat', value: @contract.contract_number } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Titre', value: @contract.title } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Type de contrat', value: @contract.contract_type } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Sous-famille d\'achats', value: @contract.purchase_subfamily } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Objet du contrat', value: @contract.contract_object } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Description d√©taill√©e', value: @contract.detailed_description } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Mode de passation', value: @contract.contracting_method } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'R√©f√©rence publique', value: @contract.public_reference } %>
            </div>
          </details>

          <!-- CATEGORY 2: STAKEHOLDERS -->
          <details style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
            <summary style="background: #f9fafb; padding: 1rem; cursor: pointer; font-weight: 600; border-radius: 8px; user-select: none;">
              üë• Parties Prenantes (10 champs)
            </summary>
            <div style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Prestataire (Organisation)', value: @contract.contractor_organization_name } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Contact prestataire', value: @contract.contractor_contact_name } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Agence prestataire', value: @contract.contractor_agency_name } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Client (Organisation)', value: @contract.client_organization_name } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Contact client', value: @contract.client_contact_name } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'D√©partement gestionnaire', value: @contract.managing_department } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Responsable suivi', value: @contract.monitoring_manager } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'T√©l√©phone prestataire', value: @contract.contractor_phone } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Email prestataire', value: @contract.contractor_email } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Email contact client', value: @contract.client_contact_email } %>
            </div>
          </details>

          <!-- CATEGORY 3: SCOPE -->
          <details style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
            <summary style="background: #f9fafb; padding: 1rem; cursor: pointer; font-weight: 600; border-radius: 8px; user-select: none;">
              üéØ P√©rim√®tre (15 champs)
            </summary>
            <div style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Sites couverts', value: (@contract.covered_sites || []).join(', '), type: 'array' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'B√¢timents couverts', value: (@contract.covered_buildings || []).join(', '), type: 'array' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Types d\'√©quipements', value: (@contract.covered_equipment_types || []).join(', '), type: 'array' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Liste √©quipements', value: @contract.covered_equipment_list } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Nombre d\'√©quipements', value: @contract.equipment_count, type: 'number' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Zones g√©ographiques', value: @contract.geographic_areas } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Noms des b√¢timents', value: @contract.building_names } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Niveaux/√âtages', value: @contract.floor_levels } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Zones sp√©cifiques', value: @contract.specific_zones } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Lot technique', value: @contract.technical_lot } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Cat√©gories √©quipements', value: @contract.equipment_categories } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Description p√©rim√®tre', value: @contract.coverage_description } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Exclusions', value: @contract.exclusions } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Conditions sp√©ciales', value: @contract.special_conditions } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Notes p√©rim√®tre', value: @contract.scope_notes } %>
            </div>
          </details>

          <!-- CATEGORY 4: FINANCIAL -->
          <details style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
            <summary style="background: #f9fafb; padding: 1rem; cursor: pointer; font-weight: 600; border-radius: 8px; user-select: none;">
              üí∞ Aspects Financiers (15 champs)
            </summary>
            <div style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Montant annuel HT', value: @contract.annual_amount_ht, type: 'currency' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Montant annuel TTC', value: @contract.annual_amount_ttc, type: 'currency' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Montant mensuel', value: @contract.monthly_amount, type: 'currency' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'M√©thode facturation', value: @contract.billing_method } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Fr√©quence facturation', value: @contract.billing_frequency } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Conditions de paiement', value: @contract.payment_terms } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Conditions r√©vision', value: @contract.revision_conditions } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Indice de r√©vision', value: @contract.revision_index } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Fr√©quence r√©vision', value: @contract.revision_frequency } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'P√©nalit√©s retard', value: @contract.late_payment_penalties } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Garantie financi√®re', value: @contract.financial_guarantee } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Montant d√©p√¥t garantie', value: @contract.deposit_amount, type: 'currency' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Date r√©vision prix', value: @contract.price_revision_date, type: 'date' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Derni√®re MAJ montant', value: @contract.last_amount_update, type: 'date' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Code budg√©taire', value: @contract.budget_code } %>
            </div>
          </details>

          <!-- CATEGORY 5: TEMPORALITY -->
          <details style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
            <summary style="background: #f9fafb; padding: 1rem; cursor: pointer; font-weight: 600; border-radius: 8px; user-select: none;">
              üìÖ Temporalit√© (10 champs)
            </summary>
            <div style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Date de signature', value: @contract.signature_date, type: 'date' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Date d√©but ex√©cution', value: @contract.execution_start_date, type: 'date' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Dur√©e initiale (mois)', value: @contract.initial_duration_months, type: 'number' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Dur√©e renouvellement (mois)', value: @contract.renewal_duration_months, type: 'number' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Nombre de renouvellements', value: @contract.renewal_count, type: 'number' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Renouvellement automatique', value: @contract.automatic_renewal, type: 'boolean' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Pr√©avis (jours)', value: @contract.notice_period_days, type: 'number' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Prochaine √©ch√©ance', value: @contract.next_deadline_date, type: 'date' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Dernier renouvellement', value: @contract.last_renewal_date, type: 'date' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Date de r√©siliation', value: @contract.termination_date, type: 'date' } %>
            </div>
          </details>

          <!-- CATEGORY 6: SERVICES & SLA -->
          <details style="border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 1rem;">
            <summary style="background: #f9fafb; padding: 1rem; cursor: pointer; font-weight: 600; border-radius: 8px; user-select: none;">
              üîß Services & SLA (12 champs)
            </summary>
            <div style="padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Nature des services', value: @contract.service_nature } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Fr√©quence intervention', value: @contract.intervention_frequency } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'D√©lai intervention (h)', value: @contract.intervention_delay_hours, type: 'number' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'D√©lai r√©solution (h)', value: @contract.resolution_delay_hours, type: 'number' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Horaires de travail', value: @contract.working_hours } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Astreinte 24/7', value: @contract.on_call_24_7, type: 'boolean' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'SLA (%)', value: @contract.sla_percentage, type: 'percentage' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'KPIs', value: (@contract.kpis || []).join(', '), type: 'array' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Pi√®ces incluses', value: @contract.spare_parts_included, type: 'boolean' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Fournitures incluses', value: @contract.supplies_included, type: 'boolean' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Rapport obligatoire', value: @contract.report_required, type: 'boolean' } %>
              <%= render partial: 'contracts/extracted_field', locals: { label: 'Documents annexes', value: (@contract.appendix_documents || []).join(', '), type: 'array' } %>
            </div>
          </details>

        </div>
      <% end %>

    </div>
  </div>
<% end %>
