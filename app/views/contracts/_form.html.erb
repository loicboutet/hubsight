<div style="background-color: var(--white); border-radius: var(--space-md);">
  <%= form_with(url: contract.respond_to?(:id) && contract.id.present? ? contract_path(contract.id) : contracts_path, method: contract.respond_to?(:id) && contract.id.present? ? :patch : :post, local: true) do |f| %>
    
    <!-- Contract Classification Section -->
    <div style="margin-bottom: var(--space-xl); padding: var(--space-lg); background-color: var(--pink-pale); border-radius: var(--space-sm);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg);">
        Type de Contrat
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Choix lors de l'input d'un nouveau contrat <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :contract_classification,
            [
              ['Contrat initial', 'initial'],
              ['Avenant', 'amendment'],
              ['Accord cadre', 'framework']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.contract_classification },
            { 
              required: true, 
              style: "width: 100%;",
              id: 'contract_classification_select',
              onchange: 'toggleParentContractField()'
            } %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary);">
            <strong>Contrat initial:</strong> Contrat principal<br>
            <strong>Avenant:</strong> Modification d'un contrat initial (association obligatoire)<br>
            <strong>Accord cadre:</strong> Peut √™tre associ√© √† des contrats (optionnel)
          </p>
        </div>

        <div id="parent_contract_field" style="<%= (contract.contract_classification == 'amendment' || contract.contract_classification == 'framework') ? '' : 'display: none;' %>">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Contrat Initial Associ√© <span id="parent_contract_required" style="color: var(--coral-primary); <%= contract.contract_classification == 'amendment' ? '' : 'display: none;' %>">*</span>
          </label>
          <%= f.text_field :parent_contract_id, 
            value: contract.parent_contract_id, 
            placeholder: "Num√©ro du contrat initial", 
            style: "width: 100%;",
            id: 'parent_contract_input' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary);">
            On doit pouvoir visualiser les avenants et accord cadre associ√©s √† un contrat initial
          </p>
        </div>
      </div>
    </div>

    <!-- PDF Document Upload Section with Drag & Drop -->
    <div data-controller="pdf-upload" data-pdf-upload-max-size-value="10485760" style="margin-bottom: var(--space-xl); padding: var(--space-lg); background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius: var(--space-sm); border: 2px solid #ffb74d;">
      <h4 class="typo-h4" style="margin-bottom: var(--space-md); color: #e65100;">
        üìÑ Document PDF du Contrat
      </h4>
      <p class="typo-body-small" style="margin-bottom: var(--space-lg); color: var(--grey-primary);">
        T√©l√©chargez le PDF du contrat (multi-pages support√©) - Taille maximale : 10 Mo
      </p>
      
      <!-- Drag and Drop Zone -->
      <div 
        data-pdf-upload-target="dropzone"
        data-action="dragenter->pdf-upload#handleDragEnter dragover->pdf-upload#handleDragOver dragleave->pdf-upload#handleDragLeave drop->pdf-upload#handleDrop"
        style="border: 3px dashed #ffb74d; border-radius: var(--space-sm); padding: var(--space-xl); text-align: center; background-color: white; transition: all 0.3s ease; cursor: pointer;"
        onclick="this.querySelector('input[type=file]').click()">
        
        <!-- Hidden File Input -->
        <%= f.file_field :pdf_document, 
          accept: 'application/pdf',
          data: { 
            pdf_upload_target: 'input',
            action: 'change->pdf-upload#handleFileSelect'
          },
          style: "display: none;" %>
        
        <!-- Upload Icon and Text -->
        <div style="margin-bottom: var(--space-md);">
          <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="#ffb74d" style="margin: 0 auto; display: block;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
        </div>
        
        <p class="typo-body-small typo-bold" style="margin-bottom: var(--space-sm); color: #e65100;">
          Glissez-d√©posez votre fichier PDF ici
        </p>
        <p class="typo-body-small" style="color: var(--grey-primary); margin-bottom: var(--space-sm);">
          ou
        </p>
        <button 
          type="button"
          data-action="click->pdf-upload#selectFile"
          style="background: linear-gradient(135deg, #ffb74d 0%, #ffa726 100%); color: white; padding: 0 32px; height: 3.315rem; font-size: 1.105rem; font-weight: 500; border: none; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(255, 183, 77, 0.3); display: inline-flex; align-items: center; gap: var(--space-sm);"
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 183, 77, 0.4)';"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(255, 183, 77, 0.3)';">
          <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          S√©lectionner un fichier
        </button>
        <p class="typo-body-small" style="margin-top: var(--space-md); color: #757575; font-size: 0.85rem;">
          Formats accept√©s : PDF uniquement ‚Ä¢ Taille max : 10 Mo
        </p>
      </div>

      <!-- Error Message -->
      <div 
        data-pdf-upload-target="errorMessage"
        style="display: none; margin-top: var(--space-md); padding: var(--space-md); background-color: #ffebee; border-left: 4px solid #f44336; border-radius: var(--space-xs);">
        <p class="typo-body-small" style="color: #c62828; margin: 0;">
          <!-- Error message will be inserted here -->
        </p>
      </div>

      <!-- File Preview -->
      <div 
        data-pdf-upload-target="preview"
        style="display: none; margin-top: var(--space-lg); padding: var(--space-md); background-color: white; border: 2px solid #4caf50; border-radius: var(--space-sm);">
        <div style="display: flex; align-items: center; justify-content: space-between;">
          <div style="display: flex; align-items: center; gap: var(--space-md);">
            <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" fill="none" viewBox="0 0 24 24" stroke="#4caf50" style="flex-shrink: 0;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <div>
              <p class="typo-body-small typo-bold" style="margin: 0; color: #2e7d32;">
                <span data-pdf-upload-target="fileName">fichier.pdf</span>
              </p>
              <p class="typo-body-small" style="margin: var(--space-xs) 0 0 0; color: #757575;">
                Taille: <span data-pdf-upload-target="fileSize">0 Mo</span>
              </p>
            </div>
          </div>
          <button 
            type="button"
            data-action="click->pdf-upload#removeFile"
            style="background: none; border: none; cursor: pointer; color: #f44336; padding: var(--space-sm);">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Progress Bar (hidden by default, for future AJAX upload) -->
      <div 
        data-pdf-upload-target="progressBar"
        style="display: none; margin-top: var(--space-md);">
        <div style="background-color: #e0e0e0; border-radius: 10px; overflow: hidden; height: 24px;">
          <div class="progress-fill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4caf50 0%, #66bb6a 100%); transition: width 0.3s ease;"></div>
        </div>
        <p class="typo-body-small" data-pdf-upload-target="progressText" style="margin-top: var(--space-xs); color: var(--grey-primary); text-align: center;">
          <!-- Progress text will be inserted here -->
        </p>
      </div>

      <!-- Existing PDF Display -->
      <% if contract.respond_to?(:pdf_attached?) && contract.pdf_attached? %>
        <div style="margin-top: var(--space-lg); padding: var(--space-md); background-color: #f1f8e9; border-left: 4px solid #8bc34a; border-radius: var(--space-xs);">
          <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="display: flex; align-items: center; gap: var(--space-md);">
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" fill="none" viewBox="0 0 24 24" stroke="#689f38">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
              </svg>
              <div>
                <p class="typo-body-small typo-bold" style="margin: 0; color: #558b2f;">
                  üìÑ PDF Actuel: <%= contract.pdf_filename %>
                </p>
                <p class="typo-body-small" style="margin: var(--space-xs) 0 0 0; color: #757575;">
                  Taille: <%= contract.pdf_filesize_mb %> Mo
                </p>
              </div>
            </div>
            <div style="display: flex; gap: var(--space-sm);">
              <%= link_to rails_blob_path(contract.pdf_document, disposition: "inline"), target: '_blank', class: 'typo-btn-success', style: 'display: inline-flex; align-items: center; gap: var(--space-xs); padding: var(--space-sm) var(--space-md); font-size: 0.9rem;' do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
                Voir
              <% end %>
              <%= link_to rails_blob_path(contract.pdf_document, disposition: "attachment"), class: 'typo-btn-primary', style: 'display: inline-flex; align-items: center; gap: var(--space-xs); padding: var(--space-sm) var(--space-md); font-size: 0.9rem;' do %>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                T√©l√©charger
              <% end %>
            </div>
          </div>
          <p class="typo-body-small" style="margin-top: var(--space-sm); color: #757575; font-style: italic;">
            üí° T√©l√©chargez un nouveau fichier ci-dessus pour remplacer le PDF actuel
          </p>
        </div>
      <% end %>
    </div>
    
    <!-- Identification Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Identification du Contrat
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Num√©ro de Contrat <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.text_field :contract_number, value: contract.contract_number, placeholder: "Ex: CTR-2024-001", required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Titre du Contrat <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.text_field :title, value: contract.title, placeholder: "Ex: Maintenance HVAC", required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Type de Contrat <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :contract_type,
            [
              ['Bail (Lease)', 'lease'],
              ['Acte de propri√©t√© (Property Deed)', 'property_deed'],
              ['Maintenance pr√©ventive', 'preventive_maintenance'],
              ['Maintenance corrective', 'corrective_maintenance'],
              ['Maintenance mixte', 'mixed_maintenance'],
              ['Nettoyage', 'cleaning'],
              ['Contr√¥le technique', 'technical_control'],
              ['Fluides', 'utilities'],
              ['Assurance', 'insurance'],
              ['Autre', 'other']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.contract_type },
            { required: true, style: "width: 100%;", id: 'contract_type_select', onchange: 'toggleContractTypeFields()' } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Famille d'Achats <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :purchase_family,
            [
              ['Maintenance', 'maintenance'],
              ['Nettoyage et Hygi√®ne', 'cleaning'],
              ['Contr√¥le Technique', 'technical_control'],
              ['Fluides', 'utilities'],
              ['Assurances', 'insurance'],
              ['Immobilier', 'real_estate'],
              ['Autres Contrats', 'other']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.purchase_family },
            { required: true, style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Sous-Famille d'Achats
          </label>
          <%= f.text_field :purchase_subfamily, value: contract.purchase_subfamily, placeholder: "Ex: Ascenseurs, CVC, √âlectricit√©", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Statut <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :status,
            [
              ['Actif', 'active'],
              ['En cours de signature', 'in_progress'],
              ['R√©sili√©', 'terminated'],
              ['Suspendu', 'suspended'],
              ['Expir√©', 'expired']
            ],
            { selected: contract.status || 'active' },
            { required: true, style: "width: 100%;" } %>
        </div>

        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Objet du Contrat <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.text_area :object, value: contract.object, rows: 3, placeholder: "Description de l'objet du contrat", required: true, style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Stakeholders Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Parties Prenantes
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <!-- Items 22-23: Replace text field with autocomplete dropdown -->
        <div data-controller="organization-autocomplete" style="position: relative;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Prestataire (Organisation) <span style="color: var(--coral-primary);">*</span>
          </label>
          
          <!-- Autocomplete input -->
          <input 
            type="text"
            data-organization-autocomplete-target="input"
            data-action="input->organization-autocomplete#search"
            placeholder="Rechercher une organisation..."
            style="width: 100%; height: 3.315rem; padding: 0 1.105rem; border: 1px solid var(--light-gray); border-radius: var(--space-sm); font-size: 1.105rem; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif; color: var(--dark-gray);"
            onfocus="this.style.borderColor='var(--coral-primary)'; this.style.boxShadow='0 0 0 3px rgba(255, 107, 107, 0.1)';"
            onblur="setTimeout(() => { this.style.borderColor='var(--light-gray)'; this.style.boxShadow='none'; }, 200);"
            required
          />
          
          <!-- Hidden field for actual selection -->
          <%= f.hidden_field :contractor_organization_id, 
            data: { organization_autocomplete_target: "hiddenField" },
            value: contract.contractor_organization_id %>
          
          <!-- Suggestions dropdown with fuzzy matching -->
          <div 
            data-organization-autocomplete-target="suggestions"
            style="position: absolute; background: white; border: 1px solid #ddd; display: none; max-height: 300px; overflow-y: auto; z-index: 1000; width: 100%; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 4px; margin-top: 4px;">
            <!-- Dynamic suggestions appear here -->
          </div>
          
          <!-- "Did you mean..." section for similar names -->
          <div 
            data-organization-autocomplete-target="similarNames"
            style="margin-top: 8px; padding: 12px; background-color: #fff3cd; border-left: 4px solid #ffc107; display: none; border-radius: 4px;">
            <p class="typo-body-small typo-bold" style="color: #856404; margin-bottom: 4px;">
              üí° Vouliez-vous dire :
            </p>
            <ul data-organization-autocomplete-target="similarList" style="margin: 0; padding-left: 20px;"></ul>
          </div>
          
          <!-- Display aliases/former names -->
          <p class="typo-body-small" style="margin-top: 4px; color: #6c757d; display: none;" data-organization-autocomplete-target="aliases"></p>
          
          <p class="typo-body-small" style="margin-top: 4px; color: #dc3545;">
            ‚ö†Ô∏è S√©lection obligatoire depuis la liste - Pas de saisie libre autoris√©e
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Contact Principal Prestataire
          </label>
          <%= f.text_field :contractor_contact, value: contract.contractor_contact, placeholder: "Nom du contact", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Email Prestataire
          </label>
          <%= f.email_field :contractor_email, value: contract.contractor_email, placeholder: "contact@prestataire.fr", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            T√©l√©phone Prestataire
          </label>
          <%= f.text_field :contractor_phone, value: contract.contractor_phone, placeholder: "+33 1 23 45 67 89", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Gestionnaire du Contrat
          </label>
          <%= f.text_field :contract_manager, value: contract.contract_manager, placeholder: "Nom du gestionnaire interne", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            D√©partement Gestionnaire
          </label>
          <%= f.text_field :managing_department, value: contract.managing_department, placeholder: "Ex: Services G√©n√©raux", style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Scope Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        P√©rim√®tre d'Application
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <!-- Items 24-25: Replace text fields with dropdowns (no free text allowed) -->
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Site Associ√© <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :site_id,
            options_for_select(
              [
                ['Tour Montparnasse - Paris 15e', 1],
                ['Si√®ge Social - La D√©fense', 2],
                ['Centre Commercial - Lyon Part-Dieu', 3],
                ['Campus Universitaire - Toulouse', 4],
                ['H√¥pital Saint-Louis - Paris 10e', 5]
              ],
              contract.site_id
            ),
            { include_blank: 'S√©lectionner un site...', prompt: 'S√©lectionner un site...' },
            { 
              required: true,
              style: "width: 100%; height: 3.315rem; padding: 0 1.105rem; border: 1px solid var(--light-gray); border-radius: var(--space-sm); font-size: 1.105rem;",
              class: "select2-dropdown"
            } %>
          <p class="typo-body-small" style="margin-top: 4px; color: #dc3545;">
            ‚ö†Ô∏è S√©lection obligatoire - Pas de saisie libre autoris√©e
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            B√¢timents Associ√©s
          </label>
          <%= f.select :building_ids,
            options_for_select(
              [
                ['B√¢timent A - Tour Montparnasse', 1],
                ['B√¢timent B - Annexe Est', 2],
                ['B√¢timent C - Annexe Ouest', 3]
              ],
              contract.building_ids
            ),
            {},
            { 
              multiple: true,
              style: "width: 100%; min-height: 100px; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--space-sm);",
              class: "select2-dropdown"
            } %>
          <p class="typo-body-small" style="margin-top: 4px; color: #6c757d;">
            üí° Maintenez Ctrl/Cmd pour s√©lectionner plusieurs b√¢timents
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            √âquipements Associ√©s
          </label>
          <%= f.select :equipment_ids,
            options_for_select(
              [
                ['Ascenseur #1 - Tour Principal', 1],
                ['Ascenseur #2 - Annexe', 2],
                ['Chaudi√®re CVC - Sous-sol', 3],
                ['Climatisation √âtage 5', 4],
                ['Groupe √âlectrog√®ne', 5],
                ['Syst√®me S√©curit√© Incendie', 6]
              ],
              contract.equipment_ids
            ),
            {},
            { 
              multiple: true,
              style: "width: 100%; min-height: 100px; padding: 0.5rem; border: 1px solid var(--light-gray); border-radius: var(--space-sm);",
              class: "select2-dropdown"
            } %>
          <p class="typo-body-small" style="margin-top: 4px; color: #6c757d;">
            üí° S√©lectionnez tous les √©quipements couverts par ce contrat
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Nombre d'√âquipements
          </label>
          <%= f.number_field :equipment_count, value: contract.equipment_count, placeholder: "Ex: 12", min: 0, style: "width: 100%;" %>
        </div>

        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Zones G√©ographiques
          </label>
          <%= f.text_area :geographic_areas, value: contract.geographic_areas, rows: 2, placeholder: "Description des zones couvertes", style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Financial Aspects Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Aspects Financiers
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Montant Annuel HT (‚Ç¨) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.number_field :annual_amount_excl_tax, value: contract.annual_amount_excl_tax, placeholder: "Ex: 50000", step: 0.01, required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Montant Annuel TTC (‚Ç¨)
          </label>
          <%= f.number_field :annual_amount_incl_tax, value: contract.annual_amount_incl_tax, placeholder: "Ex: 60000", step: 0.01, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Mode de Facturation <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :billing_method,
            [
              ['Prix forfaitaire', 'fixed_price'],
              ['R√©gie (temps pass√©)', 'time_materials'],
              ['Mixte', 'mixed']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.billing_method },
            { required: true, style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Fr√©quence de Facturation
          </label>
          <%= f.select :billing_frequency,
            [
              ['Mensuelle', 'monthly'],
              ['Trimestrielle', 'quarterly'],
              ['Semestrielle', 'biannual'],
              ['Annuelle', 'annual']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.billing_frequency },
            { style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Indice de R√©vision
          </label>
          <%= f.text_field :revision_index, value: contract.revision_index, placeholder: "Ex: TP09, ICHT", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Conditions de R√©vision
          </label>
          <%= f.text_field :revision_conditions, value: contract.revision_conditions, placeholder: "Ex: Annuelle selon indice", style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Temporality Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Temporalit√©
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Date de Signature <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.date_field :signature_date, value: contract.signature_date, required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Date de D√©but d'Ex√©cution <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.date_field :start_date, value: contract.start_date, required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Date de Fin <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.date_field :end_date, value: contract.end_date, required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Dur√©e Initiale (mois)
          </label>
          <%= f.number_field :initial_duration, value: contract.initial_duration, placeholder: "Ex: 12, 24, 36", min: 1, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Dur√©e de Reconduction (mois)
          </label>
          <%= f.number_field :renewal_duration, value: contract.renewal_duration, placeholder: "Ex: 12", min: 1, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Nombre de Reconductions Possibles
          </label>
          <%= f.number_field :renewal_count, value: contract.renewal_count, placeholder: "Ex: 2, 3", min: 0, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Reconduction Automatique
          </label>
          <%= f.select :automatic_renewal,
            [
              ['Oui', true],
              ['Non', false]
            ],
            { selected: contract.automatic_renewal },
            { style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Pr√©avis de R√©siliation (jours)
          </label>
          <%= f.number_field :termination_notice, value: contract.termination_notice, placeholder: "Ex: 30, 60, 90", min: 0, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Prochaine √âch√©ance
          </label>
          <%= f.date_field :next_deadline, value: contract.next_deadline, style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Item 5: Lease-Specific Fields Section -->
    <div id="lease_fields_section" style="margin-bottom: var(--space-xl); display: none;">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--coral-primary);">
        üìã Informations Sp√©cifiques au Bail
      </h4>
      <p class="typo-body-small" style="margin-bottom: var(--space-lg); color: var(--grey-primary);">
        Compl√©tez les informations sp√©cifiques pour un contrat de type Bail
      </p>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Type de Bail <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :lease_type,
            [
              ['Commercial', 'commercial'],
              ['Habitation', 'residential'],
              ['Bureau', 'office'],
              ['Industriel', 'industrial'],
              ['Mixte', 'mixed']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.lease_type },
            { style: "width: 100%;", class: 'lease-field' } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Surface (m¬≤) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.number_field :lease_area, value: contract.lease_area, placeholder: "Ex: 250", step: 0.01, min: 0, style: "width: 100%;", class: 'lease-field' %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Loyer Mensuel HT (‚Ç¨) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.number_field :monthly_rent_excl_tax, value: contract.monthly_rent_excl_tax, placeholder: "Ex: 3750", step: 0.01, min: 0, style: "width: 100%;", class: 'lease-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Loyer hors charges et hors taxes
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Charges Mensuelles (‚Ç¨)
          </label>
          <%= f.number_field :monthly_charges, value: contract.monthly_charges, placeholder: "Ex: 450", step: 0.01, min: 0, style: "width: 100%;", class: 'lease-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Charges locatives mensuelles
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Type d'Indexation <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :indexation_type,
            [
              ['ILC - Indice des Loyers Commerciaux', 'ILC'],
              ['ILAT - Indice des Loyers des Activit√©s Tertiaires', 'ILAT'],
              ['IRL - Indice de R√©f√©rence des Loyers', 'IRL'],
              ['ICC - Indice du Co√ªt de la Construction', 'ICC'],
              ['Autre', 'other']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.indexation_type },
            { style: "width: 100%;", class: 'lease-field' } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Taux d'Indexation (%)
          </label>
          <%= f.number_field :indexation_rate, value: contract.indexation_rate, placeholder: "Ex: 2.5", step: 0.01, min: 0, max: 100, style: "width: 100%;", class: 'lease-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Taux annuel d'√©volution de l'indice
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Date de Prise d'Effet <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.date_field :lease_effective_date, value: contract.lease_effective_date, style: "width: 100%;", class: 'lease-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Date de d√©but du bail (peut diff√©rer de la signature)
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Dur√©e du Bail (mois) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.number_field :lease_duration_months, value: contract.lease_duration_months, placeholder: "Ex: 108 (9 ans)", min: 1, style: "width: 100%;", class: 'lease-field', id: 'lease_duration_field', onchange: 'calculateNextDeadline()' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Dur√©e totale du bail en mois
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Prochaine √âch√©ance de Bail
          </label>
          <%= f.date_field :next_lease_deadline, value: contract.next_lease_deadline, style: "width: 100%;", class: 'lease-field', id: 'next_lease_deadline_field', readonly: true %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Calcul√©e automatiquement (triennal pour bail commercial)
          </p>
        </div>

        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Alertes / Notifications
          </label>
          <%= f.text_area :lease_alerts, value: contract.lease_alerts, rows: 2, placeholder: "Ex: Renouvellement proche, Indexation √† venir, Documents manquants...", style: "width: 100%;", class: 'lease-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Alertes sp√©cifiques pour ce bail (renouvellement, indexation, etc.)
          </p>
        </div>
      </div>
    </div>

    <!-- Items 9 & 10: Property Deed-Specific Fields Section -->
    <div id="property_deed_fields_section" style="margin-bottom: var(--space-xl); display: none;">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid #8b5cf6;">
        üè¢ Informations Sp√©cifiques √† l'Acte de Propri√©t√©
      </h4>
      <p class="typo-body-small" style="margin-bottom: var(--space-lg); color: var(--grey-primary);">
        Compl√©tez les informations sp√©cifiques pour un contrat de type Acte de Propri√©t√©
      </p>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Date d'Acquisition <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.date_field :property_acquisition_date, value: contract.property_acquisition_date, style: "width: 100%;", class: 'property-deed-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Date d'acquisition du bien immobilier
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Surface (m¬≤) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.number_field :property_area, value: contract.property_area, placeholder: "Ex: 850", step: 0.01, min: 0, style: "width: 100%;", class: 'property-deed-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Surface totale du bien en m√®tres carr√©s
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Type d'Usage <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :property_usage_type,
            [
              ['Bureaux', 'office'],
              ['R√©sidentiel', 'residential'],
              ['Commercial', 'commercial'],
              ['Industriel', 'industrial'],
              ['Mixte', 'mixed']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.property_usage_type },
            { style: "width: 100%;", class: 'property-deed-field' } %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Type d'utilisation principale du bien
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Type de Propri√©t√© <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :property_ownership_type,
            [
              ['Pleine propri√©t√©', 'full_ownership'],
              ['Usufruit', 'usufruct'],
              ['Nue-propri√©t√©', 'bare_ownership'],
              ['Copropri√©t√©', 'co_ownership']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.property_ownership_type },
            { style: "width: 100%;", class: 'property-deed-field' } %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Nature juridique de la propri√©t√©
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Prix d'Acquisition (‚Ç¨) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.number_field :property_acquisition_price, value: contract.property_acquisition_price, placeholder: "Ex: 1800000", step: 0.01, min: 0, style: "width: 100%;", class: 'property-deed-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Prix d'achat initial du bien
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Valeur de March√© Actuelle (‚Ç¨)
          </label>
          <%= f.number_field :property_current_market_value, value: contract.property_current_market_value, placeholder: "Ex: 1850000", step: 0.01, min: 0, style: "width: 100%;", class: 'property-deed-field', id: 'property_current_market_value_field', onchange: 'updateMarketValueDate()' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Estimation actuelle de la valeur du bien
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Date MAJ Valeur de March√©
          </label>
          <%= f.date_field :property_market_value_last_update, value: contract.property_market_value_last_update, style: "width: 100%;", class: 'property-deed-field', id: 'property_market_value_last_update_field', readonly: true %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Date de derni√®re mise √† jour de la valeur (auto)
          </p>
        </div>

        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Alertes (Annexe Diagnostic Manquante)
          </label>
          <%= f.text_area :property_deed_alerts, value: contract.property_deed_alerts, rows: 2, placeholder: "Ex: Diagnostic de performance √©nerg√©tique manquant, Diagnostic amiante √† renouveler...", style: "width: 100%;", class: 'property-deed-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Alertes concernant les documents ou diagnostics manquants
          </p>
        </div>
      </div>
    </div>

    <!-- Services & SLA Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Services et Niveau de Service
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Nature des Prestations
          </label>
          <%= f.text_area :service_nature, value: contract.service_nature, rows: 3, placeholder: "Description des prestations fournies", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Fr√©quence d'Intervention
          </label>
          <%= f.text_field :intervention_frequency, value: contract.intervention_frequency, placeholder: "Ex: Mensuelle, Trimestrielle", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            D√©lai d'Intervention (heures)
          </label>
          <%= f.number_field :intervention_delay, value: contract.intervention_delay, placeholder: "Ex: 4, 24, 48", min: 0, step: 0.5, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            D√©lai de R√©solution (heures)
          </label>
          <%= f.number_field :resolution_delay, value: contract.resolution_delay, placeholder: "Ex: 24, 48, 72", min: 0, step: 0.5, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Horaires d'Intervention
          </label>
          <%= f.text_field :working_hours, value: contract.working_hours, placeholder: "Ex: 8h-18h, Lun-Ven", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Astreinte 24/7
          </label>
          <%= f.select :on_call_24_7,
            [
              ['Oui', true],
              ['Non', false]
            ],
            { selected: contract.on_call_24_7 },
            { style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Niveau de Service Garanti (%)
          </label>
          <%= f.number_field :service_level, value: contract.service_level, placeholder: "Ex: 95, 98, 99", min: 0, max: 100, step: 0.1, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Pi√®ces de Rechange Incluses
          </label>
          <%= f.select :spare_parts_included,
            [
              ['Oui', true],
              ['Non', false]
            ],
            { selected: contract.spare_parts_included },
            { style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Rapport d'Intervention Obligatoire
          </label>
          <%= f.select :intervention_report_required,
            [
              ['Oui', true],
              ['Non', false]
            ],
            { selected: contract.intervention_report_required },
            { style: "width: 100%;" } %>
        </div>

        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Indicateurs de Performance (KPI)
          </label>
          <%= f.text_area :kpi, value: contract.kpi, rows: 2, placeholder: "Ex: Taux de disponibilit√©, temps de r√©ponse, satisfaction client", style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Additional Notes Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Notes et Documents
      </h4>
      
      <div>
        <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
          Notes / Observations
        </label>
        <%= f.text_area :notes, value: contract.notes, rows: 4, placeholder: "Notes compl√©mentaires, clauses particuli√®res, etc.", style: "width: 100%;" %>
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="display: flex; gap: var(--space-md); justify-content: flex-end; padding-top: var(--space-lg); border-top: 1px solid var(--pink-pale);">
      <%= link_to contracts_path, class: "typo-btn-cancel", style: "display: inline-flex; align-items: center; gap: var(--space-sm);" do %>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        Annuler
      <% end %>
      <button type="submit" class="typo-btn-success" style="cursor: pointer; display: inline-flex; align-items: center; gap: var(--space-sm);">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <%= (contract.respond_to?(:id) && contract.id.present?) ? "Mettre √† Jour" : "Cr√©er le Contrat" %>
      </button>
    </div>
  <% end %>
</div>

<script>
function toggleParentContractField() {
  const select = document.getElementById('contract_classification_select');
  const parentField = document.getElementById('parent_contract_field');
  const requiredIndicator = document.getElementById('parent_contract_required');
  const parentInput = document.getElementById('parent_contract_input');
  
  if (!select || !parentField) return;
  
  const value = select.value;
  
  if (value === 'amendment' || value === 'framework') {
    parentField.style.display = 'block';
    
    if (value === 'amendment') {
      // Required for amendments
      if (requiredIndicator) requiredIndicator.style.display = 'inline';
      if (parentInput) parentInput.required = true;
    } else {
      // Optional for framework agreements
      if (requiredIndicator) requiredIndicator.style.display = 'none';
      if (parentInput) parentInput.required = false;
    }
  } else {
    // Hide for initial contracts
    parentField.style.display = 'none';
    if (parentInput) parentInput.required = false;
  }
}

// Items 5, 9 & 10: Toggle lease and property deed fields based on contract type
function toggleContractTypeFields() {
  const contractTypeSelect = document.getElementById('contract_type_select');
  const leaseFieldsSection = document.getElementById('lease_fields_section');
  const propertyDeedFieldsSection = document.getElementById('property_deed_fields_section');
  const leaseFields = document.querySelectorAll('.lease-field');
  const propertyDeedFields = document.querySelectorAll('.property-deed-field');
  
  if (!contractTypeSelect) return;
  
  const contractType = contractTypeSelect.value;
  
  // Handle Lease fields
  if (contractType === 'lease') {
    if (leaseFieldsSection) leaseFieldsSection.style.display = 'block';
    leaseFields.forEach(field => {
      if (field.previousElementSibling?.textContent.includes('*')) {
        field.required = true;
      }
    });
  } else {
    if (leaseFieldsSection) leaseFieldsSection.style.display = 'none';
    leaseFields.forEach(field => {
      field.required = false;
    });
  }
  
  // Handle Property Deed fields
  if (contractType === 'property_deed') {
    if (propertyDeedFieldsSection) propertyDeedFieldsSection.style.display = 'block';
    propertyDeedFields.forEach(field => {
      if (field.previousElementSibling?.textContent.includes('*')) {
        field.required = true;
      }
    });
  } else {
    if (propertyDeedFieldsSection) propertyDeedFieldsSection.style.display = 'none';
    propertyDeedFields.forEach(field => {
      field.required = false;
    });
  }
}

// Calculate next lease deadline (triennial for commercial leases)
function calculateNextDeadline() {
  const effectiveDateField = document.querySelector('[name*="lease_effective_date"]');
  const durationField = document.getElementById('lease_duration_field');
  const nextDeadlineField = document.getElementById('next_lease_deadline_field');
  
  if (!effectiveDateField || !durationField || !nextDeadlineField) return;
  
  const effectiveDate = effectiveDateField.value;
  const duration = parseInt(durationField.value);
  
  if (effectiveDate && duration) {
    // Parse the effective date
    const date = new Date(effectiveDate);
    
    // For commercial leases, calculate triennial deadline (36 months)
    // Note: This is a simplified version. Backend should handle actual calculation
    const triennialMonths = 36;
    const nextDeadline = new Date(date);
    nextDeadline.setMonth(nextDeadline.getMonth() + triennialMonths);
    
    // Format as YYYY-MM-DD for date input
    const formattedDate = nextDeadline.toISOString().split('T')[0];
    nextDeadlineField.value = formattedDate;
  }
}

// Detect if we're editing a lease or property deed contract and set the contract type
function detectAndSetContractType() {
  const contractTypeSelect = document.getElementById('contract_type_select');
  if (!contractTypeSelect) return;
  
  // Check if we're editing a known lease contract (BAIL prefix)
  const currentPath = window.location.pathname;
  if (currentPath.includes('/bail-') || currentPath.includes('/BAIL-')) {
    contractTypeSelect.value = 'lease';
    toggleContractTypeFields();
  }
  // Check if we're editing a known property deed contract (PROP prefix)
  else if (currentPath.includes('/prop-') || currentPath.includes('/PROP-')) {
    contractTypeSelect.value = 'property_deed';
    toggleContractTypeFields();
  }
  // Otherwise, use whatever is already selected
  else if (contractTypeSelect.value) {
    toggleContractTypeFields();
  }
}

// Run on page load
document.addEventListener('DOMContentLoaded', function() {
  toggleParentContractField();
  detectAndSetContractType();
  
  // Add event listener for effective date changes
  const effectiveDateField = document.querySelector('[name*="lease_effective_date"]');
  if (effectiveDateField) {
    effectiveDateField.addEventListener('change', calculateNextDeadline);
  }
});
</script>
