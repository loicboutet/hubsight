<div style="background-color: var(--white); border-radius: var(--space-md);">
  <%= form_with(url: contract.respond_to?(:id) && contract.id.present? ? contract_path(contract.id) : contracts_path, method: contract.respond_to?(:id) && contract.id.present? ? :patch : :post, local: true) do |f| %>
    
    <!-- Contract Classification Section -->
    <div style="margin-bottom: var(--space-xl); padding: var(--space-lg); background-color: var(--pink-pale); border-radius: var(--space-sm);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg);">
        Type de Contrat
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Choix lors de l'input d'un nouveau contrat <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :contract_classification,
            [
              ['Contrat initial', 'initial'],
              ['Avenant', 'amendment'],
              ['Accord cadre', 'framework']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.contract_classification },
            { 
              required: true, 
              style: "width: 100%;",
              id: 'contract_classification_select',
              onchange: 'toggleParentContractField()'
            } %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary);">
            <strong>Contrat initial:</strong> Contrat principal<br>
            <strong>Avenant:</strong> Modification d'un contrat initial (association obligatoire)<br>
            <strong>Accord cadre:</strong> Peut √™tre associ√© √† des contrats (optionnel)
          </p>
        </div>

        <div id="parent_contract_field" style="<%= (contract.contract_classification == 'amendment' || contract.contract_classification == 'framework') ? '' : 'display: none;' %>">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Contrat Initial Associ√© <span id="parent_contract_required" style="color: var(--coral-primary); <%= contract.contract_classification == 'amendment' ? '' : 'display: none;' %>">*</span>
          </label>
          <%= f.text_field :parent_contract_id, 
            value: contract.parent_contract_id, 
            placeholder: "Num√©ro du contrat initial", 
            style: "width: 100%;",
            id: 'parent_contract_input' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary);">
            On doit pouvoir visualiser les avenants et accord cadre associ√©s √† un contrat initial
          </p>
        </div>
      </div>
    </div>

    <!-- PDF Document Upload Section -->
    <div style="margin-bottom: var(--space-xl); padding: var(--space-lg); background-color: #fff3e0; border-radius: var(--space-sm);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-md);">
        Document PDF du Contrat
      </h4>
      <p class="typo-body-small" style="margin-bottom: var(--space-md); color: var(--grey-primary);">
        Il faut pouvoir retrouver la version PDF import√© du contrat dans la fiche contrat (et donc une zone o√π sont stock√©s les contrats au format PDF)
      </p>
      
      <div>
        <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
          Importer le PDF du Contrat
        </label>
        <%= f.file_field :pdf_file, 
          accept: 'application/pdf',
          style: "width: 100%;" %>
        <% if contract.respond_to?(:pdf_url) && contract.pdf_url.present? %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--green-primary);">
            üìÑ Document PDF existant : 
            <%= link_to "Voir le PDF", contract.pdf_url, target: '_blank', class: 'typo-link' %>
          </p>
        <% end %>
      </div>
    </div>
    
    <!-- Identification Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Identification du Contrat
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Num√©ro de Contrat <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.text_field :contract_number, value: contract.contract_number, placeholder: "Ex: CTR-2024-001", required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Titre du Contrat <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.text_field :title, value: contract.title, placeholder: "Ex: Maintenance HVAC", required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Type de Contrat <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :contract_type,
            [
              ['Bail (Lease)', 'lease'],
              ['Acte de propri√©t√© (Property Deed)', 'property_deed'],
              ['Maintenance pr√©ventive', 'preventive_maintenance'],
              ['Maintenance corrective', 'corrective_maintenance'],
              ['Maintenance mixte', 'mixed_maintenance'],
              ['Nettoyage', 'cleaning'],
              ['Contr√¥le technique', 'technical_control'],
              ['Fluides', 'utilities'],
              ['Assurance', 'insurance'],
              ['Autre', 'other']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.contract_type },
            { required: true, style: "width: 100%;", id: 'contract_type_select', onchange: 'toggleContractTypeFields()' } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Famille d'Achats <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :purchase_family,
            [
              ['Maintenance', 'maintenance'],
              ['Nettoyage et Hygi√®ne', 'cleaning'],
              ['Contr√¥le Technique', 'technical_control'],
              ['Fluides', 'utilities'],
              ['Assurances', 'insurance'],
              ['Immobilier', 'real_estate'],
              ['Autres Contrats', 'other']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.purchase_family },
            { required: true, style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Sous-Famille d'Achats
          </label>
          <%= f.text_field :purchase_subfamily, value: contract.purchase_subfamily, placeholder: "Ex: Ascenseurs, CVC, √âlectricit√©", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Statut <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :status,
            [
              ['Actif', 'active'],
              ['En cours de signature', 'in_progress'],
              ['R√©sili√©', 'terminated'],
              ['Suspendu', 'suspended'],
              ['Expir√©', 'expired']
            ],
            { selected: contract.status || 'active' },
            { required: true, style: "width: 100%;" } %>
        </div>

        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Objet du Contrat <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.text_area :object, value: contract.object, rows: 3, placeholder: "Description de l'objet du contrat", required: true, style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Stakeholders Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Parties Prenantes
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Prestataire (Organisation) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.text_field :contractor_organization, value: contract.contractor_organization, placeholder: "Nom du prestataire", required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Contact Principal Prestataire
          </label>
          <%= f.text_field :contractor_contact, value: contract.contractor_contact, placeholder: "Nom du contact", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Email Prestataire
          </label>
          <%= f.email_field :contractor_email, value: contract.contractor_email, placeholder: "contact@prestataire.fr", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            T√©l√©phone Prestataire
          </label>
          <%= f.text_field :contractor_phone, value: contract.contractor_phone, placeholder: "+33 1 23 45 67 89", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Gestionnaire du Contrat
          </label>
          <%= f.text_field :contract_manager, value: contract.contract_manager, placeholder: "Nom du gestionnaire interne", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            D√©partement Gestionnaire
          </label>
          <%= f.text_field :managing_department, value: contract.managing_department, placeholder: "Ex: Services G√©n√©raux", style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Scope Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        P√©rim√®tre d'Application
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Sites Couverts
          </label>
          <%= f.text_field :covered_sites, value: contract.covered_sites, placeholder: "Ex: Tous sites, Site A, Site B", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            B√¢timents Couverts
          </label>
          <%= f.text_field :covered_buildings, value: contract.covered_buildings, placeholder: "Ex: Tous b√¢timents, B√¢t. A", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Type d'√âquipement Concern√©
          </label>
          <%= f.text_field :equipment_type, value: contract.equipment_type, placeholder: "Ex: Ascenseurs, CVC, Plomberie", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Nombre d'√âquipements
          </label>
          <%= f.number_field :equipment_count, value: contract.equipment_count, placeholder: "Ex: 12", min: 0, style: "width: 100%;" %>
        </div>

        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Zones G√©ographiques
          </label>
          <%= f.text_area :geographic_areas, value: contract.geographic_areas, rows: 2, placeholder: "Description des zones couvertes", style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Financial Aspects Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Aspects Financiers
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Montant Annuel HT (‚Ç¨) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.number_field :annual_amount_excl_tax, value: contract.annual_amount_excl_tax, placeholder: "Ex: 50000", step: 0.01, required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Montant Annuel TTC (‚Ç¨)
          </label>
          <%= f.number_field :annual_amount_incl_tax, value: contract.annual_amount_incl_tax, placeholder: "Ex: 60000", step: 0.01, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Mode de Facturation <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :billing_method,
            [
              ['Prix forfaitaire', 'fixed_price'],
              ['R√©gie (temps pass√©)', 'time_materials'],
              ['Mixte', 'mixed']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.billing_method },
            { required: true, style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Fr√©quence de Facturation
          </label>
          <%= f.select :billing_frequency,
            [
              ['Mensuelle', 'monthly'],
              ['Trimestrielle', 'quarterly'],
              ['Semestrielle', 'biannual'],
              ['Annuelle', 'annual']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.billing_frequency },
            { style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Indice de R√©vision
          </label>
          <%= f.text_field :revision_index, value: contract.revision_index, placeholder: "Ex: TP09, ICHT", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Conditions de R√©vision
          </label>
          <%= f.text_field :revision_conditions, value: contract.revision_conditions, placeholder: "Ex: Annuelle selon indice", style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Temporality Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Temporalit√©
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Date de Signature <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.date_field :signature_date, value: contract.signature_date, required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Date de D√©but d'Ex√©cution <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.date_field :start_date, value: contract.start_date, required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Date de Fin <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.date_field :end_date, value: contract.end_date, required: true, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Dur√©e Initiale (mois)
          </label>
          <%= f.number_field :initial_duration, value: contract.initial_duration, placeholder: "Ex: 12, 24, 36", min: 1, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Dur√©e de Reconduction (mois)
          </label>
          <%= f.number_field :renewal_duration, value: contract.renewal_duration, placeholder: "Ex: 12", min: 1, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Nombre de Reconductions Possibles
          </label>
          <%= f.number_field :renewal_count, value: contract.renewal_count, placeholder: "Ex: 2, 3", min: 0, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Reconduction Automatique
          </label>
          <%= f.select :automatic_renewal,
            [
              ['Oui', true],
              ['Non', false]
            ],
            { selected: contract.automatic_renewal },
            { style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Pr√©avis de R√©siliation (jours)
          </label>
          <%= f.number_field :termination_notice, value: contract.termination_notice, placeholder: "Ex: 30, 60, 90", min: 0, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Prochaine √âch√©ance
          </label>
          <%= f.date_field :next_deadline, value: contract.next_deadline, style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Item 5: Lease-Specific Fields Section -->
    <div id="lease_fields_section" style="margin-bottom: var(--space-xl); display: none;">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--coral-primary);">
        üìã Informations Sp√©cifiques au Bail
      </h4>
      <p class="typo-body-small" style="margin-bottom: var(--space-lg); color: var(--grey-primary);">
        Compl√©tez les informations sp√©cifiques pour un contrat de type Bail
      </p>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Type de Bail <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :lease_type,
            [
              ['Commercial', 'commercial'],
              ['Habitation', 'residential'],
              ['Bureau', 'office'],
              ['Industriel', 'industrial'],
              ['Mixte', 'mixed']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.lease_type },
            { style: "width: 100%;", class: 'lease-field' } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Surface (m¬≤) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.number_field :lease_area, value: contract.lease_area, placeholder: "Ex: 250", step: 0.01, min: 0, style: "width: 100%;", class: 'lease-field' %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Loyer Mensuel HT (‚Ç¨) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.number_field :monthly_rent_excl_tax, value: contract.monthly_rent_excl_tax, placeholder: "Ex: 3750", step: 0.01, min: 0, style: "width: 100%;", class: 'lease-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Loyer hors charges et hors taxes
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Charges Mensuelles (‚Ç¨)
          </label>
          <%= f.number_field :monthly_charges, value: contract.monthly_charges, placeholder: "Ex: 450", step: 0.01, min: 0, style: "width: 100%;", class: 'lease-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Charges locatives mensuelles
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Type d'Indexation <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.select :indexation_type,
            [
              ['ILC - Indice des Loyers Commerciaux', 'ILC'],
              ['ILAT - Indice des Loyers des Activit√©s Tertiaires', 'ILAT'],
              ['IRL - Indice de R√©f√©rence des Loyers', 'IRL'],
              ['ICC - Indice du Co√ªt de la Construction', 'ICC'],
              ['Autre', 'other']
            ],
            { include_blank: 'S√©lectionner...', selected: contract.indexation_type },
            { style: "width: 100%;", class: 'lease-field' } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Taux d'Indexation (%)
          </label>
          <%= f.number_field :indexation_rate, value: contract.indexation_rate, placeholder: "Ex: 2.5", step: 0.01, min: 0, max: 100, style: "width: 100%;", class: 'lease-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Taux annuel d'√©volution de l'indice
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Date de Prise d'Effet <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.date_field :lease_effective_date, value: contract.lease_effective_date, style: "width: 100%;", class: 'lease-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Date de d√©but du bail (peut diff√©rer de la signature)
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Dur√©e du Bail (mois) <span style="color: var(--coral-primary);">*</span>
          </label>
          <%= f.number_field :lease_duration_months, value: contract.lease_duration_months, placeholder: "Ex: 108 (9 ans)", min: 1, style: "width: 100%;", class: 'lease-field', id: 'lease_duration_field', onchange: 'calculateNextDeadline()' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Dur√©e totale du bail en mois
          </p>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Prochaine √âch√©ance de Bail
          </label>
          <%= f.date_field :next_lease_deadline, value: contract.next_lease_deadline, style: "width: 100%;", class: 'lease-field', id: 'next_lease_deadline_field', readonly: true %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Calcul√©e automatiquement (triennal pour bail commercial)
          </p>
        </div>

        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Alertes / Notifications
          </label>
          <%= f.text_area :lease_alerts, value: contract.lease_alerts, rows: 2, placeholder: "Ex: Renouvellement proche, Indexation √† venir, Documents manquants...", style: "width: 100%;", class: 'lease-field' %>
          <p class="typo-body-small" style="margin-top: var(--space-xs); color: var(--grey-primary); font-size: 0.75rem;">
            Alertes sp√©cifiques pour ce bail (renouvellement, indexation, etc.)
          </p>
        </div>
      </div>
    </div>

    <!-- Services & SLA Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Services et Niveau de Service
      </h4>
      
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-lg);">
        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Nature des Prestations
          </label>
          <%= f.text_area :service_nature, value: contract.service_nature, rows: 3, placeholder: "Description des prestations fournies", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Fr√©quence d'Intervention
          </label>
          <%= f.text_field :intervention_frequency, value: contract.intervention_frequency, placeholder: "Ex: Mensuelle, Trimestrielle", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            D√©lai d'Intervention (heures)
          </label>
          <%= f.number_field :intervention_delay, value: contract.intervention_delay, placeholder: "Ex: 4, 24, 48", min: 0, step: 0.5, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            D√©lai de R√©solution (heures)
          </label>
          <%= f.number_field :resolution_delay, value: contract.resolution_delay, placeholder: "Ex: 24, 48, 72", min: 0, step: 0.5, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Horaires d'Intervention
          </label>
          <%= f.text_field :working_hours, value: contract.working_hours, placeholder: "Ex: 8h-18h, Lun-Ven", style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Astreinte 24/7
          </label>
          <%= f.select :on_call_24_7,
            [
              ['Oui', true],
              ['Non', false]
            ],
            { selected: contract.on_call_24_7 },
            { style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Niveau de Service Garanti (%)
          </label>
          <%= f.number_field :service_level, value: contract.service_level, placeholder: "Ex: 95, 98, 99", min: 0, max: 100, step: 0.1, style: "width: 100%;" %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Pi√®ces de Rechange Incluses
          </label>
          <%= f.select :spare_parts_included,
            [
              ['Oui', true],
              ['Non', false]
            ],
            { selected: contract.spare_parts_included },
            { style: "width: 100%;" } %>
        </div>

        <div>
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Rapport d'Intervention Obligatoire
          </label>
          <%= f.select :intervention_report_required,
            [
              ['Oui', true],
              ['Non', false]
            ],
            { selected: contract.intervention_report_required },
            { style: "width: 100%;" } %>
        </div>

        <div style="grid-column: 1 / -1;">
          <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
            Indicateurs de Performance (KPI)
          </label>
          <%= f.text_area :kpi, value: contract.kpi, rows: 2, placeholder: "Ex: Taux de disponibilit√©, temps de r√©ponse, satisfaction client", style: "width: 100%;" %>
        </div>
      </div>
    </div>

    <!-- Additional Notes Section -->
    <div style="margin-bottom: var(--space-xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
        Notes et Documents
      </h4>
      
      <div>
        <label class="typo-body-small typo-bold" style="display: block; margin-bottom: var(--space-sm);">
          Notes / Observations
        </label>
        <%= f.text_area :notes, value: contract.notes, rows: 4, placeholder: "Notes compl√©mentaires, clauses particuli√®res, etc.", style: "width: 100%;" %>
      </div>
    </div>

    <!-- Action Buttons -->
    <div style="display: flex; gap: var(--space-md); justify-content: flex-end; padding-top: var(--space-lg); border-top: 1px solid var(--pink-pale);">
      <%= link_to contracts_path, class: "typo-btn-cancel", style: "display: inline-flex; align-items: center; gap: var(--space-sm);" do %>
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
        Annuler
      <% end %>
      <button type="submit" class="typo-btn-success" style="cursor: pointer; display: inline-flex; align-items: center; gap: var(--space-sm);">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <%= (contract.respond_to?(:id) && contract.id.present?) ? "Mettre √† Jour" : "Cr√©er le Contrat" %>
      </button>
    </div>
  <% end %>
</div>

<script>
function toggleParentContractField() {
  const select = document.getElementById('contract_classification_select');
  const parentField = document.getElementById('parent_contract_field');
  const requiredIndicator = document.getElementById('parent_contract_required');
  const parentInput = document.getElementById('parent_contract_input');
  
  if (!select || !parentField) return;
  
  const value = select.value;
  
  if (value === 'amendment' || value === 'framework') {
    parentField.style.display = 'block';
    
    if (value === 'amendment') {
      // Required for amendments
      if (requiredIndicator) requiredIndicator.style.display = 'inline';
      if (parentInput) parentInput.required = true;
    } else {
      // Optional for framework agreements
      if (requiredIndicator) requiredIndicator.style.display = 'none';
      if (parentInput) parentInput.required = false;
    }
  } else {
    // Hide for initial contracts
    parentField.style.display = 'none';
    if (parentInput) parentInput.required = false;
  }
}

// Item 5: Toggle lease-specific fields based on contract type
function toggleContractTypeFields() {
  const contractTypeSelect = document.getElementById('contract_type_select');
  const leaseFieldsSection = document.getElementById('lease_fields_section');
  const leaseFields = document.querySelectorAll('.lease-field');
  
  if (!contractTypeSelect || !leaseFieldsSection) return;
  
  const contractType = contractTypeSelect.value;
  
  if (contractType === 'lease') {
    // Show lease fields section
    leaseFieldsSection.style.display = 'block';
    // Make lease fields required
    leaseFields.forEach(field => {
      if (field.hasAttribute('data-required') || field.previousElementSibling?.textContent.includes('*')) {
        field.required = true;
      }
    });
  } else {
    // Hide lease fields section
    leaseFieldsSection.style.display = 'none';
    // Remove required attribute from lease fields
    leaseFields.forEach(field => {
      field.required = false;
    });
  }
  
  // TODO: Add similar logic for property_deed type when implemented
  // if (contractType === 'property_deed') { ... }
}

// Calculate next lease deadline (triennial for commercial leases)
function calculateNextDeadline() {
  const effectiveDateField = document.querySelector('[name*="lease_effective_date"]');
  const durationField = document.getElementById('lease_duration_field');
  const nextDeadlineField = document.getElementById('next_lease_deadline_field');
  
  if (!effectiveDateField || !durationField || !nextDeadlineField) return;
  
  const effectiveDate = effectiveDateField.value;
  const duration = parseInt(durationField.value);
  
  if (effectiveDate && duration) {
    // Parse the effective date
    const date = new Date(effectiveDate);
    
    // For commercial leases, calculate triennial deadline (36 months)
    // Note: This is a simplified version. Backend should handle actual calculation
    const triennialMonths = 36;
    const nextDeadline = new Date(date);
    nextDeadline.setMonth(nextDeadline.getMonth() + triennialMonths);
    
    // Format as YYYY-MM-DD for date input
    const formattedDate = nextDeadline.toISOString().split('T')[0];
    nextDeadlineField.value = formattedDate;
  }
}

// Run on page load
document.addEventListener('DOMContentLoaded', function() {
  toggleParentContractField();
  toggleContractTypeFields();
  
  // Add event listener for effective date changes
  const effectiveDateField = document.querySelector('[name*="lease_effective_date"]');
  if (effectiveDateField) {
    effectiveDateField.addEventListener('change', calculateNextDeadline);
  }
});
</script>
