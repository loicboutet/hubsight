<% content_for :header, "Mes Équipements" %>

<div class="section">
  <!-- Read-Only Access Notice -->
  <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: var(--space-lg); border-radius: var(--space-md); margin-bottom: var(--space-xl); display: flex; align-items: center; gap: var(--space-md);">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="flex-shrink: 0;">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
    <div>
      <p class="typo-body-small typo-bold" style="margin-bottom: var(--space-xs);">Accès en lecture seule</p>
      <p class="typo-body-small" style="opacity: 0.9;">Vous pouvez consulter les équipements de vos sites assignés mais ne pouvez pas les modifier.</p>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-lg); margin-bottom: var(--space-xl);">
    <!-- Total Equipment -->
    <div style="background: linear-gradient(135deg, #FFC107 0%, #FF9800 100%); color: white; padding: var(--space-lg); border-radius: var(--space-md);">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-sm);">
        <span class="typo-body-small" style="opacity: 0.9;">Total Équipements</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
        </svg>
      </div>
      <p class="typo-h2" style="font-weight: 700;"><%= @total_count %></p>
    </div>

    <!-- Active Equipment -->
    <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: var(--space-lg); border-radius: var(--space-md);">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-sm);">
        <span class="typo-body-small" style="opacity: 0.9;">Actifs</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <p class="typo-h2" style="font-weight: 700;"><%= @active_count %></p>
    </div>

    <!-- Maintenance Equipment -->
    <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: var(--space-lg); border-radius: var(--space-md);">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-sm);">
        <span class="typo-body-small" style="opacity: 0.9;">En Maintenance</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
        </svg>
      </div>
      <p class="typo-h2" style="font-weight: 700;"><%= @maintenance_count %></p>
    </div>

    <!-- Critical Equipment -->
    <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; padding: var(--space-lg); border-radius: var(--space-md);">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: var(--space-sm);">
        <span class="typo-body-small" style="opacity: 0.9;">Critiques</span>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <p class="typo-h2" style="font-weight: 700;"><%= @critical_count %></p>
    </div>
  </div>

  <!-- Filters and Search -->
  <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-lg); margin-bottom: var(--space-xl);">
    <%= form_with url: my_equipment_index_path, method: :get, local: true, style: "display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md); align-items: end;" do |f| %>
      <!-- Site Filter -->
      <div>
        <label class="typo-label" style="display: block; margin-bottom: var(--space-xs);">Site</label>
        <%= select_tag :site_id, 
            options_for_select([['Tous les sites', '']] + @assigned_sites.map { |s| [s.name, s.id] }, params[:site_id]),
            class: "typo-input" %>
      </div>

      <!-- Status Filter -->
      <div>
        <label class="typo-label" style="display: block; margin-bottom: var(--space-xs);">Statut</label>
        <%= select_tag :status,
            options_for_select([
              ['Tous les statuts', ''],
              ['Actif', 'active'],
              ['Inactif', 'inactive'],
              ['En maintenance', 'maintenance'],
              ['Hors service', 'out_of_service']
            ], params[:status]),
            class: "typo-input" %>
      </div>

      <!-- Search -->
      <div>
        <label class="typo-label" style="display: block; margin-bottom: var(--space-xs);">Recherche</label>
        <%= text_field_tag :search, params[:search], 
            placeholder: "Nom, fabricant, modèle...",
            class: "typo-input" %>
      </div>

      <!-- Buttons -->
      <div style="display: flex; gap: var(--space-sm);">
        <%= submit_tag "Filtrer", class: "typo-btn-primary" %>
        <%= link_to "Réinitialiser", my_equipment_index_path, class: "typo-btn-secondary" %>
      </div>
    <% end %>
  </div>

  <% if @equipment.any? %>
    <!-- Equipment List Grouped by Site -->
    <% @equipment_by_site.each do |site, equipment_list| %>
      <div style="margin-bottom: var(--space-xl);">
        <!-- Site Header -->
        <div style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: var(--space-md) var(--space-lg); border-radius: var(--space-md) var(--space-md) 0 0;">
          <div style="display: flex; align-items: center; gap: var(--space-sm);">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            <h3 class="typo-h3"><%= site.name %></h3>
            <span class="typo-body-small" style="opacity: 0.9; margin-left: auto;">(<%= equipment_list.count %> équipement<%= equipment_list.count > 1 ? 's' : '' %>)</span>
          </div>
        </div>

        <!-- Equipment Table -->
        <div style="background-color: var(--white); border-radius: 0 0 var(--space-md) var(--space-md); overflow: hidden;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead style="background-color: var(--pink-pale);">
              <tr>
                <th class="typo-body-small typo-bold" style="padding: var(--space-md); text-align: left;">Nom</th>
                <th class="typo-body-small typo-bold" style="padding: var(--space-md); text-align: left;">Type</th>
                <th class="typo-body-small typo-bold" style="padding: var(--space-md); text-align: left;">Fabricant</th>
                <th class="typo-body-small typo-bold" style="padding: var(--space-md); text-align: left;">Localisation</th>
                <th class="typo-body-small typo-bold" style="padding: var(--space-md); text-align: left;">Statut</th>
                <th class="typo-body-small typo-bold" style="padding: var(--space-md); text-align: left;">Criticité</th>
                <th class="typo-body-small typo-bold" style="padding: var(--space-md); text-align: center;">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% equipment_list.each do |equipment| %>
                <tr style="border-bottom: 1px solid var(--pink-pale);">
                  <td style="padding: var(--space-md);">
                    <%= link_to equipment.name, my_equipment_path(equipment), class: "typo-body-small typo-bold", style: "color: var(--coral-primary); text-decoration: none;" %>
                  </td>
                  <td style="padding: var(--space-md);">
                    <% if equipment.equipment_type %>
                      <span class="typo-body-small"><%= equipment.equipment_type.equipment_type_name %></span>
                    <% else %>
                      <span class="typo-body-small" style="color: var(--medium-gray);">-</span>
                    <% end %>
                  </td>
                  <td style="padding: var(--space-md);">
                    <span class="typo-body-small"><%= equipment.manufacturer || '-' %></span>
                  </td>
                  <td style="padding: var(--space-md);">
                    <span class="typo-body-small" style="color: var(--medium-gray); font-size: 0.875rem;">
                      <%= equipment.building&.name || '-' %> > 
                      <%= equipment.level&.name || '-' %> > 
                      <%= equipment.space&.name || '-' %>
                    </span>
                  </td>
                  <td style="padding: var(--space-md);">
                    <% status_colors = {
                      'active' => { bg: '#d4edda', text: '#155724' },
                      'inactive' => { bg: '#f8d7da', text: '#721c24' },
                      'maintenance' => { bg: '#fff3cd', text: '#856404' },
                      'out_of_service' => { bg: '#f8d7da', text: '#721c24' },
                      'decommissioned' => { bg: '#e2e3e5', text: '#383d41' }
                    } %>
                    <% color = status_colors[equipment.status] || { bg: '#e2e3e5', text: '#383d41' } %>
                    <span style="display: inline-block; padding: 4px 10px; background-color: <%= color[:bg] %>; color: <%= color[:text] %>; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                      <%= equipment.status_label %>
                    </span>
                  </td>
                  <td style="padding: var(--space-md);">
                    <% if equipment.criticality.present? %>
                      <% criticality_colors = {
                        'low' => { bg: '#d4edda', text: '#155724' },
                        'medium' => { bg: '#fff3cd', text: '#856404' },
                        'high' => { bg: '#fff3cd', text: '#856404' },
                        'critical' => { bg: '#f8d7da', text: '#721c24' }
                      } %>
                      <% color = criticality_colors[equipment.criticality] || { bg: '#e2e3e5', text: '#383d41' } %>
                      <span style="display: inline-block; padding: 4px 10px; background-color: <%= color[:bg] %>; color: <%= color[:text] %>; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                        <%= equipment.criticality_label %>
                      </span>
                    <% else %>
                      <span class="typo-body-small">-</span>
                    <% end %>
                  </td>
                  <td style="padding: var(--space-md); text-align: center;">
                    <%= link_to my_equipment_path(equipment), class: "typo-btn-small typo-btn-small-primary" do %>
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                      </svg>
                      Voir
                    <% end %>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    <% end %>

    <!-- Pagination -->
    <% if @equipment.respond_to?(:total_pages) && @equipment.total_pages > 1 %>
      <div style="margin-top: var(--space-lg); text-align: center;">
        <%= paginate @equipment %>
      </div>
    <% end %>
  <% else %>
    <!-- Empty State -->
    <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-xxl); text-align: center;">
      <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="none" viewBox="0 0 24 24" stroke="var(--medium-gray)" style="margin: 0 auto;">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
      <h3 class="typo-h3" style="margin-top: var(--space-lg); color: var(--gray-secondary);">Aucun équipement trouvé</h3>
      <p class="typo-body" style="color: var(--medium-gray); margin-top: var(--space-sm);">
        <% if params[:search].present? || params[:site_id].present? || params[:status].present? %>
          Aucun équipement ne correspond à vos critères de recherche.
        <% else %>
          Aucun équipement n'est encore enregistré pour vos sites assignés.
        <% end %>
      </p>
      <% if params[:search].present? || params[:site_id].present? || params[:status].present? %>
        <%= link_to "Réinitialiser les filtres", my_equipment_index_path, class: "typo-btn-secondary", style: "margin-top: var(--space-lg);" %>
      <% end %>
    </div>
  <% end %>
</div>
