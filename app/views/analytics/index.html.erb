<% content_for :header, "Analytics" %>

<div class="section">
  <div style="margin-bottom: var(--space-xl);">
    <%= render 'shared/breadcrumb', path: [
      { name: 'Analytics', url: nil }
    ] %>
  </div>

  <div class="page-header-responsive">
    <div>
      <h2 class="typo-h2" style="margin-bottom: var(--space-sm);">Analytics d'Usage de la Plateforme</h2>
      <p class="typo-body-small">Statistiques d'utilisation et activitÃ© des utilisateurs</p>
    </div>
  </div>

  <!-- USER ACTIVITY KPI CARDS -->
  <div class="admin-stats-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-lg); margin-bottom: var(--space-2xl);">
    <!-- Total Active Users -->
    <div class="admin-stat-card">
      <div class="admin-stat-header">
        <div>
          <div class="admin-stat-label">Utilisateurs Actifs</div>
          <div class="admin-stat-value"><%= @total_active_users %></div>
          <div class="admin-stat-change">sur <%= @total_users %> utilisateurs totaux</div>
        </div>
        <div class="admin-stat-icon purple">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
        </div>
      </div>
    </div>

    <!-- New Users This Week -->
    <div class="admin-stat-card">
      <div class="admin-stat-header">
        <div>
          <div class="admin-stat-label">Nouveaux Utilisateurs</div>
          <div class="admin-stat-value"><%= @new_users_this_week %></div>
          <div class="admin-stat-change">cette semaine</div>
        </div>
        <div class="admin-stat-icon green">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
          </svg>
        </div>
      </div>
    </div>

    <!-- Connections This Week -->
    <div class="admin-stat-card">
      <div class="admin-stat-header">
        <div>
          <div class="admin-stat-label">Connexions Semaine</div>
          <div class="admin-stat-value"><%= @connections_this_week %></div>
          <div class="admin-stat-change">DurÃ©e moy.: <%= @avg_session_duration %></div>
        </div>
        <div class="admin-stat-icon blue">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
          </svg>
        </div>
      </div>
    </div>

    <!-- Connections This Month -->
    <div class="admin-stat-card">
      <div class="admin-stat-header">
        <div>
          <div class="admin-stat-label">Connexions Mois</div>
          <div class="admin-stat-value"><%= @connections_this_month %></div>
          <div class="admin-stat-change">Moyenne: <%= (@connections_this_month / 30.0).round %>/jour</div>
        </div>
        <div class="admin-stat-icon coral">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
        </div>
      </div>
    </div>
  </div>

  <!-- CONTRACT ENTRY ACTIVITY SECTION -->
  <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-xl); margin-bottom: var(--space-xl);">
    <h3 class="typo-h3" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
      ActivitÃ© de Saisie des Contrats
    </h3>
    
    <!-- Quick Stats -->
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--space-lg); margin-bottom: var(--space-xl);">
      <div style="text-align: center; padding: var(--space-md); background-color: #f0f9ff; border-radius: var(--space-sm);">
        <p class="typo-body-small" style="color: #666; margin-bottom: var(--space-xs);">24 derniÃ¨res heures</p>
        <p class="typo-h2" style="margin: 0; color: #0369a1;"><%= @contracts_last_24h %></p>
      </div>
      <div style="text-align: center; padding: var(--space-md); background-color: #f0fdf4; border-radius: var(--space-sm);">
        <p class="typo-body-small" style="color: #666; margin-bottom: var(--space-xs);">48 derniÃ¨res heures</p>
        <p class="typo-h2" style="margin: 0; color: #15803d;"><%= @contracts_last_48h %></p>
      </div>
      <div style="text-align: center; padding: var(--space-md); background-color: #fef3c7; border-radius: var(--space-sm);">
        <p class="typo-body-small" style="color: #666; margin-bottom: var(--space-xs);">Cette semaine</p>
        <p class="typo-h2" style="margin: 0; color: #ca8a04;"><%= @contracts_this_week %></p>
      </div>
      <div style="text-align: center; padding: var(--space-md); background-color: #fce7f3; border-radius: var(--space-sm);">
        <p class="typo-body-small" style="color: #666; margin-bottom: var(--space-xs);">Ce mois</p>
        <p class="typo-h2" style="margin: 0; color: var(--coral-primary);"><%= @contracts_this_month %></p>
      </div>
    </div>

    <!-- Charts Grid -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-xl);">
      <!-- Weekly Trend -->
      <div>
        <h4 class="typo-h4" style="margin-bottom: var(--space-md);">Tendance Hebdomadaire</h4>
        <div style="display: flex; align-items-end; justify-content: space-between; height: 180px; gap: 8px;">
          <% max_count = @weekly_contract_trend.map { |w| w[:count] }.max %>
          <% @weekly_contract_trend.each do |week_data| %>
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
              <span class="typo-body-small typo-bold" style="margin-bottom: 4px; color: var(--coral-primary);"><%= week_data[:count] %></span>
              <div style="background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); width: 100%; height: <%= (week_data[:count].to_f / max_count * 150).round %>px; border-radius: 4px 4px 0 0;"></div>
              <p class="typo-body-small" style="margin-top: var(--space-xs); font-size: 0.75rem; color: #666;"><%= week_data[:week] %></p>
            </div>
          <% end %>
        </div>
      </div>

      <!-- Daily Trend (Current Week) -->
      <div>
        <h4 class="typo-h4" style="margin-bottom: var(--space-md);">ActivitÃ© de la Semaine</h4>
        <div style="display: flex; align-items-end; justify-content: space-between; height: 180px; gap: 8px;">
          <% max_daily = @daily_contract_trend.map { |d| d[:count] }.max %>
          <% max_daily = 1 if max_daily == 0 %>
          <% @daily_contract_trend.each do |day_data| %>
            <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
              <span class="typo-body-small typo-bold" style="margin-bottom: 4px; color: #10b981;"><%= day_data[:count] %></span>
              <div style="background: linear-gradient(180deg, #10b981 0%, #059669 100%); width: 100%; height: <%= day_data[:count] > 0 ? (day_data[:count].to_f / max_daily * 150).round : 0 %>px; border-radius: 4px 4px 0 0;"></div>
              <p class="typo-body-small" style="margin-top: var(--space-xs); font-size: 0.75rem; color: #666;"><%= day_data[:day] %></p>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- ACTIVITY BY PORTFOLIO CLIENT -->
  <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-xl); margin-bottom: var(--space-xl);">
    <h3 class="typo-h3" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
      ActivitÃ© par Portefeuille Client
    </h3>
    
    <div class="table-responsive">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f8f9fa; border-bottom: 2px solid var(--pink-pale);">
            <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">CLIENT</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">24H</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">48H</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">SEMAINE</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">MOIS</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">UTILISATEURS ACTIFS</th>
            <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">DERNIÃˆRE ACTIVITÃ‰</th>
          </tr>
        </thead>
        <tbody>
          <% @client_activity.each_with_index do |client, index| %>
            <tr style="border-bottom: 1px solid #e9ecef; <%= 'background-color: #fafbfc;' if index.even? %>">
              <td style="padding: var(--space-md);">
                <span class="typo-body-small typo-bold"><%= client[:name] %></span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <span style="display: inline-block; padding: 4px 10px; background-color: <%= client[:contracts_24h] > 0 ? '#dbeafe' : '#f3f4f6' %>; color: <%= client[:contracts_24h] > 0 ? '#1e40af' : '#6b7280' %>; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                  <%= client[:contracts_24h] %>
                </span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <span style="display: inline-block; padding: 4px 10px; background-color: <%= client[:contracts_48h] > 0 ? '#dbeafe' : '#f3f4f6' %>; color: <%= client[:contracts_48h] > 0 ? '#1e40af' : '#6b7280' %>; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                  <%= client[:contracts_48h] %>
                </span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <span style="display: inline-block; padding: 4px 10px; background-color: <%= client[:contracts_week] > 0 ? '#fef3c7' : '#f3f4f6' %>; color: <%= client[:contracts_week] > 0 ? '#92400e' : '#6b7280' %>; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                  <%= client[:contracts_week] %>
                </span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <span style="display: inline-block; padding: 4px 10px; background-color: <%= client[:contracts_month] > 0 ? '#fce7f3' : '#f3f4f6' %>; color: <%= client[:contracts_month] > 0 ? '#9f1239' : '#6b7280' %>; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                  <%= client[:contracts_month] %>
                </span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <span class="typo-body-small typo-bold" style="color: var(--coral-primary);"><%= client[:active_users] %></span>
              </td>
              <td style="padding: var(--space-md);">
                <span class="typo-body-small" style="color: #666;">Il y a <%= client[:last_activity] %></span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ACTIVITY BY SITE -->
  <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-xl); margin-bottom: var(--space-xl);">
    <h3 class="typo-h3" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
      ActivitÃ© par Site
    </h3>
    
    <div class="table-responsive">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f8f9fa; border-bottom: 2px solid var(--pink-pale);">
            <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">SITE</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">24H</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">48H</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">SEMAINE</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">MOIS</th>
            <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">UTIL. LE PLUS ACTIF</th>
            <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">DERNIÃˆRE ACTIVITÃ‰</th>
          </tr>
        </thead>
        <tbody>
          <% @site_activity.each_with_index do |site, index| %>
            <tr style="border-bottom: 1px solid #e9ecef; <%= 'background-color: #fafbfc;' if index.even? %>">
              <td style="padding: var(--space-md);">
                <span class="typo-body-small typo-bold"><%= site[:name] %></span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <span style="display: inline-block; padding: 4px 10px; background-color: <%= site[:contracts_24h] > 0 ? '#dbeafe' : '#f3f4f6' %>; color: <%= site[:contracts_24h] > 0 ? '#1e40af' : '#6b7280' %>; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                  <%= site[:contracts_24h] %>
                </span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <span style="display: inline-block; padding: 4px 10px; background-color: <%= site[:contracts_48h] > 0 ? '#dbeafe' : '#f3f4f6' %>; color: <%= site[:contracts_48h] > 0 ? '#1e40af' : '#6b7280' %>; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                  <%= site[:contracts_48h] %>
                </span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <span style="display: inline-block; padding: 4px 10px; background-color: <%= site[:contracts_week] > 0 ? '#fef3c7' : '#f3f4f6' %>; color: <%= site[:contracts_week] > 0 ? '#92400e' : '#6b7280' %>; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                  <%= site[:contracts_week] %>
                </span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <span style="display: inline-block; padding: 4px 10px; background-color: <%= site[:contracts_month] > 0 ? '#fce7f3' : '#f3f4f6' %>; color: <%= site[:contracts_month] > 0 ? '#9f1239' : '#6b7280' %>; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                  <%= site[:contracts_month] %>
                </span>
              </td>
              <td style="padding: var(--space-md);">
                <span class="typo-body-small"><%= site[:most_active_user] %></span>
              </td>
              <td style="padding: var(--space-md);">
                <span class="typo-body-small" style="color: #666;">Il y a <%= site[:last_activity] %></span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- PERSONALIZED ALERTS WITH DEADLINES (GREEN HIGHLIGHTING) -->
  <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-xl); margin-bottom: var(--space-xl);">
    <h3 class="typo-h3" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
      Ã‰chÃ©ances Alertes PersonnalisÃ©es
    </h3>
    
    <div class="table-responsive">
      <table style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr style="background-color: #f8f9fa; border-bottom: 2px solid var(--pink-pale);">
            <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">TYPE</th>
            <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">DESCRIPTION</th>
            <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">SITE</th>
            <th style="padding: var(--space-md); text-align: left; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">Ã‰CHÃ‰ANCE</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">JOURS RESTANTS</th>
            <th style="padding: var(--space-md); text-align: center; font-weight: 600; color: var(--gray-secondary); font-size: 0.875rem;">PRIORITÃ‰</th>
          </tr>
        </thead>
        <tbody>
          <% @personalized_alerts.each_with_index do |alert, index| %>
            <% 
              # Green highlighting for upcoming deadlines (within 7 days)
              highlight_green = alert[:days_remaining] <= 7
              row_bg = highlight_green ? '#d1fae5' : (index.even? ? '#fafbfc' : '#ffffff')
            %>
            <tr style="border-bottom: 1px solid #e9ecef; background-color: <%= row_bg %>;">
              <td style="padding: var(--space-md);">
                <span class="typo-body-small typo-bold" style="color: <%= highlight_green ? '#065f46' : '#374151' %>;"><%= alert[:type] %></span>
              </td>
              <td style="padding: var(--space-md);">
                <span class="typo-body-small" style="color: <%= highlight_green ? '#065f46' : '#4b5563' %>;"><%= alert[:description] %></span>
              </td>
              <td style="padding: var(--space-md);">
                <span class="typo-body-small" style="color: #666;"><%= alert[:site] %></span>
              </td>
              <td style="padding: var(--space-md);">
                <span class="typo-body-small" style="color: <%= highlight_green ? '#065f46' : '#374151' %>;"><%= alert[:deadline].strftime('%d/%m/%Y') %></span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <span style="display: inline-block; padding: 4px 10px; background-color: <%= highlight_green ? '#10b981' : '#fbbf24' %>; color: white; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
                  <%= alert[:days_remaining] %> jours
                </span>
              </td>
              <td style="padding: var(--space-md); text-align: center;">
                <% 
                  priority_colors = {
                    'high' => { bg: '#fee2e2', text: '#991b1b' },
                    'medium' => { bg: '#fef3c7', text: '#92400e' },
                    'low' => { bg: '#dbeafe', text: '#1e40af' }
                  }
                  colors = priority_colors[alert[:priority]]
                %>
                <span style="display: inline-block; padding: 4px 10px; background-color: <%= colors[:bg] %>; color: <%= colors[:text] %>; border-radius: 12px; font-size: 0.75rem; font-weight: 600; text-transform: capitalize;">
                  <%= alert[:priority] == 'high' ? 'Haute' : (alert[:priority] == 'medium' ? 'Moyenne' : 'Basse') %>
                </span>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ADDITIONAL METRICS -->
  <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-lg);">
    <!-- Peak Usage Hours -->
    <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-lg);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-md);">Heures de Pointe</h4>
      <% @peak_usage_hours.each do |period| %>
        <div style="margin-bottom: var(--space-sm);">
          <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
            <span class="typo-body-small"><%= period[:hour] %></span>
            <span class="typo-body-small typo-bold"><%= period[:percentage] %>%</span>
          </div>
          <div style="background-color: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: <%= period[:percentage] %>%;"></div>
          </div>
        </div>
      <% end %>
    </div>

    <!-- Most Active Users -->
    <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-lg);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-md);">Utilisateurs les Plus Actifs</h4>
      <% @most_active_users.each_with_index do |user, index| %>
        <div style="display: flex; justify-content: space-between; align-items: center; padding: var(--space-sm) 0; border-bottom: <%= index == @most_active_users.length - 1 ? 'none' : '1px solid #e9ecef' %>;">
          <div>
            <p class="typo-body-small typo-bold" style="margin: 0; margin-bottom: 2px;"><%= user[:name] %></p>
            <p class="typo-body-small" style="margin: 0; color: #666; font-size: 0.75rem;"><%= user[:role] %></p>
          </div>
          <span style="display: inline-block; padding: 4px 10px; background-color: var(--pink-pale); color: var(--coral-primary); border-radius: 12px; font-size: 0.75rem; font-weight: 600;">
            <%= user[:actions] %>
          </span>
        </div>
      <% end %>
    </div>

    <!-- Feature Usage -->
    <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-lg);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-md);">FonctionnalitÃ©s les Plus UtilisÃ©es</h4>
      <% @feature_usage.each do |feature| %>
        <div style="margin-bottom: var(--space-sm);">
          <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
            <span class="typo-body-small"><%= feature[:feature] %></span>
            <span class="typo-body-small typo-bold"><%= feature[:views] %></span>
          </div>
          <div style="background-color: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
            <div style="background-color: var(--coral-primary); height: 100%; width: <%= feature[:percentage] %>%;"></div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- CONTRACT DISTRIBUTION ANALYSIS -->
  <!-- ========================================== -->
  <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-xl); margin-bottom: var(--space-xl);">
    <h3 class="typo-h3" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
      ðŸ“Š Analyse de la Distribution des Contrats
    </h3>

    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--space-2xl);">
      <!-- Contract Distribution by Family -->
      <div>
        <h4 class="typo-h4" style="margin-bottom: var(--space-lg);">RÃ©partition par Famille de Contrats</h4>
        <div style="display: flex; gap: var(--space-xl);">
          <!-- Donut Chart -->
          <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
            <div style="position: relative; width: 200px; height: 200px;">
              <svg width="200" height="200" viewBox="0 0 200 200">
                <% total = @contract_by_family.sum { |c| c[:count] } %>
                <% start_angle = -90 %>
                <% @contract_by_family.each do |contract| %>
                  <% angle = (contract[:count].to_f / total) * 360 %>
                  <% end_angle = start_angle + angle %>
                  <% start_rad = start_angle * Math::PI / 180 %>
                  <% end_rad = end_angle * Math::PI / 180 %>
                  <% outer_radius = 100 %>
                  <% inner_radius = 60 %>
                  <% x1 = 100 + outer_radius * Math.cos(start_rad) %>
                  <% y1 = 100 + outer_radius * Math.sin(start_rad) %>
                  <% x2 = 100 + outer_radius * Math.cos(end_rad) %>
                  <% y2 = 100 + outer_radius * Math.sin(end_rad) %>
                  <% x3 = 100 + inner_radius * Math.cos(end_rad) %>
                  <% y3 = 100 + inner_radius * Math.sin(end_rad) %>
                  <% x4 = 100 + inner_radius * Math.cos(start_rad) %>
                  <% y4 = 100 + inner_radius * Math.sin(start_rad) %>
                  <% large_arc = angle > 180 ? 1 : 0 %>
                  <path d="M <%= x1 %>,<%= y1 %> A <%= outer_radius %>,<%= outer_radius %> 0 <%= large_arc %>,1 <%= x2 %>,<%= y2 %> L <%= x3 %>,<%= y3 %> A <%= inner_radius %>,<%= inner_radius %> 0 <%= large_arc %>,0 <%= x4 %>,<%= y4 %> Z" fill="<%= contract[:color] %>" opacity="0.9" />
                  <% start_angle = end_angle %>
                <% end %>
              </svg>
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div class="typo-h2" style="margin: 0; color: var(--coral-primary);"><%= total %></div>
                <div class="typo-body-small" style="color: #666;">contrats</div>
              </div>
            </div>
          </div>
          
          <!-- Legend -->
          <div style="flex: 1;">
            <% @contract_by_family.each do |contract| %>
              <div style="display: flex; align-items: center; margin-bottom: var(--space-md); padding: var(--space-sm); background-color: #f8f9fa; border-radius: var(--space-sm);">
                <div style="width: 16px; height: 16px; background-color: <%= contract[:color] %>; border-radius: 4px; margin-right: var(--space-sm); flex-shrink: 0;"></div>
                <div style="flex: 1; min-width: 0;">
                  <div class="typo-body-small typo-bold" style="color: #333; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;"><%= contract[:family] %></div>
                  <div class="typo-body-small" style="color: #666; font-size: 0.75rem;"><%= contract[:count] %> contrats Â· <%= contract[:percentage] %>%</div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <!-- Contract Distribution by Status -->
      <div>
        <h4 class="typo-h4" style="margin-bottom: var(--space-lg);">RÃ©partition par Statut</h4>
        <div style="display: flex; gap: var(--space-xl);">
          <!-- Donut Chart -->
          <div style="flex: 1; display: flex; align-items: center; justify-content: center;">
            <div style="position: relative; width: 200px; height: 200px;">
              <svg width="200" height="200" viewBox="0 0 200 200">
                <% total_status = @contract_by_status.sum { |c| c[:count] } %>
                <% start_angle = -90 %>
                <% @contract_by_status.each do |status| %>
                  <% angle = (status[:count].to_f / total_status) * 360 %>
                  <% end_angle = start_angle + angle %>
                  <% start_rad = start_angle * Math::PI / 180 %>
                  <% end_rad = end_angle * Math::PI / 180 %>
                  <% outer_radius = 100 %>
                  <% inner_radius = 60 %>
                  <% x1 = 100 + outer_radius * Math.cos(start_rad) %>
                  <% y1 = 100 + outer_radius * Math.sin(start_rad) %>
                  <% x2 = 100 + outer_radius * Math.cos(end_rad) %>
                  <% y2 = 100 + outer_radius * Math.sin(end_rad) %>
                  <% x3 = 100 + inner_radius * Math.cos(end_rad) %>
                  <% y3 = 100 + inner_radius * Math.sin(end_rad) %>
                  <% x4 = 100 + inner_radius * Math.cos(start_rad) %>
                  <% y4 = 100 + inner_radius * Math.sin(start_rad) %>
                  <% large_arc = angle > 180 ? 1 : 0 %>
                  <path d="M <%= x1 %>,<%= y1 %> A <%= outer_radius %>,<%= outer_radius %> 0 <%= large_arc %>,1 <%= x2 %>,<%= y2 %> L <%= x3 %>,<%= y3 %> A <%= inner_radius %>,<%= inner_radius %> 0 <%= large_arc %>,0 <%= x4 %>,<%= y4 %> Z" fill="<%= status[:color] %>" opacity="0.9" />
                  <% start_angle = end_angle %>
                <% end %>
              </svg>
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                <div class="typo-h2" style="margin: 0; color: var(--coral-primary);"><%= total_status %></div>
                <div class="typo-body-small" style="color: #666;">contrats</div>
              </div>
            </div>
          </div>
          
          <!-- Legend -->
          <div style="flex: 1;">
            <% @contract_by_status.each do |status| %>
              <div style="display: flex; align-items: center; margin-bottom: var(--space-md); padding: var(--space-sm); background-color: #f8f9fa; border-radius: var(--space-sm);">
                <div style="width: 16px; height: 16px; background-color: <%= status[:color] %>; border-radius: 4px; margin-right: var(--space-sm); flex-shrink: 0;"></div>
                <div style="flex: 1; min-width: 0;">
                  <div class="typo-body-small typo-bold" style="color: #333;"><%= status[:status] %></div>
                  <div class="typo-body-small" style="color: #666; font-size: 0.75rem;"><%= status[:count] %> contrats Â· <%= status[:percentage] %>%</div>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- SPENDING TRENDS ANALYSIS -->
  <!-- ========================================== -->
  <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-xl); margin-bottom: var(--space-xl);">
    <h3 class="typo-h3" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
      ðŸ’° Analyse des Tendances de DÃ©penses
    </h3>

    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-lg); margin-bottom: var(--space-2xl);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: var(--space-lg); border-radius: var(--space-md);">
        <div class="typo-body-small" style="opacity: 0.9; margin-bottom: var(--space-xs);">Budget Total Annuel</div>
        <div class="typo-h2" style="margin: 0;"><%= number_to_currency(@budget_total, unit: 'â‚¬', separator: ' ', delimiter: ' ', format: '%n %u') %></div>
      </div>
      <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: var(--space-lg); border-radius: var(--space-md);">
        <div class="typo-body-small" style="opacity: 0.9; margin-bottom: var(--space-xs);">DÃ©penses Actuelles</div>
        <div class="typo-h2" style="margin: 0;"><%= number_to_currency(@total_annual_spending, unit: 'â‚¬', separator: ' ', delimiter: ' ', format: '%n %u') %></div>
      </div>
      <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: var(--space-lg); border-radius: var(--space-md);">
        <div class="typo-body-small" style="opacity: 0.9; margin-bottom: var(--space-xs);">Utilisation Budget</div>
        <div class="typo-h2" style="margin: 0;"><%= @budget_used_percentage %>%</div>
      </div>
    </div>

    <!-- Monthly Spending Trend Chart -->
    <div style="margin-bottom: var(--space-2xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg);">Ã‰volution Mensuelle des DÃ©penses</h4>
      <div style="display: flex; align-items: flex-end; justify-content: space-between; height: 250px; gap: 8px; padding: var(--space-lg); background-color: #f8f9fa; border-radius: var(--space-md);">
        <% max_amount = @monthly_spending.map { |m| [m[:amount], m[:budget]].max }.max %>
        <% @monthly_spending.each do |month_data| %>
          <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; position: relative;">
            <!-- Budget bar (background) -->
            <div style="position: absolute; bottom: 0; width: 100%; display: flex; flex-direction: column; align-items: center;">
              <span class="typo-body-small" style="margin-bottom: 4px; font-size: 0.65rem; color: #999;"><%= number_to_human(month_data[:budget], format: '%n%u', units: {thousand: 'k', million: 'M'}) %></span>
              <div style="background-color: #e0e0e0; width: 80%; height: <%= (month_data[:budget].to_f / max_amount * 200).round %>px; border-radius: 4px 4px 0 0; opacity: 0.5;"></div>
            </div>
            <!-- Actual spending bar -->
            <div style="position: absolute; bottom: 0; width: 100%; display: flex; flex-direction: column; align-items: center; z-index: 1;">
              <span class="typo-body-small typo-bold" style="margin-bottom: 4px; font-size: 0.7rem; color: <%= month_data[:amount] > month_data[:budget] ? '#ef4444' : '#10b981' %>;"><%= number_to_human(month_data[:amount], format: '%n%u', units: {thousand: 'k', million: 'M'}) %></span>
              <div style="background: <%= month_data[:amount] > month_data[:budget] ? 'linear-gradient(180deg, #ef4444 0%, #dc2626 100%)' : 'linear-gradient(180deg, #10b981 0%, #059669 100%)' %>; width: 60%; height: <%= (month_data[:amount].to_f / max_amount * 200).round %>px; border-radius: 4px 4px 0 0;"></div>
            </div>
            <p class="typo-body-small" style="margin-top: var(--space-sm); font-size: 0.75rem; color: #666;"><%= month_data[:month] %></p>
          </div>
        <% end %>
      </div>
      <div style="display: flex; justify-content: center; gap: var(--space-xl); margin-top: var(--space-md);">
        <div style="display: flex; align-items: center; gap: var(--space-xs);">
          <div style="width: 20px; height: 12px; background: linear-gradient(90deg, #10b981 0%, #059669 100%); border-radius: 2px;"></div>
          <span class="typo-body-small" style="color: #666;">DÃ©penses rÃ©elles</span>
        </div>
        <div style="display: flex; align-items: center; gap: var(--space-xs);">
          <div style="width: 20px; height: 12px; background-color: #e0e0e0; opacity: 0.5; border-radius: 2px;"></div>
          <span class="typo-body-small" style="color: #666;">Budget</span>
        </div>
      </div>
    </div>

    <!-- Spending by Family -->
    <div>
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg);">DÃ©penses par Famille de Contrats</h4>
      <% @spending_by_family.each do |family| %>
        <div style="margin-bottom: var(--space-md);">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
            <span class="typo-body-small typo-bold"><%= family[:family] %></span>
            <div style="text-align: right;">
              <span class="typo-body-small typo-bold" style="color: <%= family[:color] %>;"><%= number_to_currency(family[:amount], unit: 'â‚¬', separator: ' ', delimiter: ' ', format: '%n %u') %></span>
              <span class="typo-body-small" style="color: #666; margin-left: var(--space-sm);"><%= family[:percentage] %>%</span>
            </div>
          </div>
          <div style="background-color: #e0e0e0; height: 12px; border-radius: 6px; overflow: hidden;">
            <div style="background-color: <%= family[:color] %>; height: 100%; width: <%= family[:percentage] %>%; border-radius: 6px;"></div>
          </div>
        </div>
      <% end %>
    </div>
  </div>

  <!-- ========================================== -->
  <!-- EQUIPMENT DISTRIBUTION ANALYSIS -->
  <!-- ========================================== -->
  <div style="background-color: var(--white); border-radius: var(--space-md); padding: var(--space-xl); margin-bottom: var(--space-xl);">
    <h3 class="typo-h3" style="margin-bottom: var(--space-lg); padding-bottom: var(--space-md); border-bottom: 2px solid var(--pink-pale);">
      ðŸ”§ Analyse de la Distribution des Ã‰quipements
    </h3>

    <!-- Total Equipment Count -->
    <div style="text-align: center; background-color: #f0f9ff; padding: var(--space-lg); border-radius: var(--space-md); margin-bottom: var(--space-2xl);">
      <div class="typo-body-small" style="color: #666; margin-bottom: var(--space-xs);">Total d'Ã‰quipements</div>
      <div class="typo-display" style="margin: 0; color: var(--coral-primary); font-size: 3rem;"><%= @total_equipment_count %></div>
    </div>

    <!-- Equipment by Type -->
    <div style="margin-bottom: var(--space-2xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg);">RÃ©partition par Type d'Ã‰quipement</h4>
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-md);">
        <% @equipment_by_type.each do |equipment| %>
          <div style="padding: var(--space-md); background-color: #f8f9fa; border-radius: var(--space-sm); border-left: 4px solid <%= equipment[:color] %>;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-xs);">
              <span class="typo-body-small typo-bold" style="color: #333;"><%= equipment[:type] %></span>
              <span class="typo-body-small typo-bold" style="color: <%= equipment[:color] %>;"><%= equipment[:count] %></span>
            </div>
            <div style="background-color: #e0e0e0; height: 8px; border-radius: 4px; overflow: hidden;">
              <div style="background-color: <%= equipment[:color] %>; height: 100%; width: <%= equipment[:percentage] %>%;"></div>
            </div>
            <div class="typo-body-small" style="color: #666; margin-top: var(--space-xs); font-size: 0.75rem;"><%= equipment[:percentage] %>% du total</div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Equipment by Site (Top 10) -->
    <div style="margin-bottom: var(--space-2xl);">
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg);">Top 10 Sites par Nombre d'Ã‰quipements</h4>
      <div style="display: flex; align-items: flex-end; justify-content: space-between; height: 320px; gap: 8px; padding: var(--space-lg); background-color: #f8f9fa; border-radius: var(--space-md);">
        <% max_equipment = @equipment_by_site.map { |s| s[:count] }.max %>
        <% @equipment_by_site.each_with_index do |site_data, index| %>
          <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
            <span class="typo-body-small typo-bold" style="margin-bottom: 4px; color: var(--coral-primary); font-size: 0.75rem;"><%= site_data[:count] %></span>
            <div style="background: linear-gradient(180deg, #667eea 0%, #764ba2 100%); width: 100%; height: <%= (site_data[:count].to_f / max_equipment * 180).round %>px; border-radius: 4px 4px 0 0;"></div>
            <p class="typo-body-small" style="margin-top: var(--space-xs); font-size: 0.65rem; color: #666; writing-mode: vertical-rl; text-orientation: mixed; max-height: 80px; overflow: hidden; text-overflow: ellipsis;"><%= site_data[:site] %></p>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Equipment Age Distribution -->
    <div>
      <h4 class="typo-h4" style="margin-bottom: var(--space-lg);">RÃ©partition par Ã‚ge des Ã‰quipements</h4>
      <div style="display: flex; gap: var(--space-sm); height: 60px; border-radius: var(--space-md); overflow: hidden;">
        <% @equipment_age_distribution.each do |age| %>
          <div style="flex: <%= age[:percentage] %>; background-color: <%= age[:color] %>; display: flex; align-items: center; justify-content: center; position: relative; min-width: 60px;">
            <div style="text-align: center; color: white; padding: var(--space-xs);">
              <div class="typo-body-small typo-bold" style="font-size: 0.75rem;"><%= age[:count] %></div>
              <div class="typo-body-small" style="font-size: 0.65rem; opacity: 0.9;"><%= age[:percentage] %>%</div>
            </div>
          </div>
        <% end %>
      </div>
      <div style="display: flex; justify-content: space-around; margin-top: var(--space-md); flex-wrap: wrap; gap: var(--space-sm);">
        <% @equipment_age_distribution.each do |age| %>
          <div style="display: flex; align-items: center; gap: var(--space-xs);">
            <div style="width: 16px; height: 16px; background-color: <%= age[:color] %>; border-radius: 4px;"></div>
            <span class="typo-body-small" style="color: #666; font-size: 0.75rem;"><%= age[:age_range] %></span>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
